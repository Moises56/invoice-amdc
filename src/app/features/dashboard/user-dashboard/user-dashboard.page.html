<ion-header class="ion-no-border">
  <!-- Status Bar Safe Area -->
  <div class="safe-area-spacer"></div>

  <ion-toolbar class="header-toolbar">
    <ion-buttons slot="start">
      <ion-menu-button class="menu-btn"></ion-menu-button>
    </ion-buttons>

    <ion-title class="header-title">
      <div class="title-content">
        <span class="title-main">Dashboard</span>
        <span class="title-sub">Panel de Control</span>
      </div>
    </ion-title>

    <ion-buttons slot="end" class="header-actions">
      <!-- Notifications -->
      <ion-button fill="clear" class="action-btn notification-btn">
        <ion-icon name="notifications-outline"></ion-icon>
        <div class="notification-badge"></div>
      </ion-button>

      <!-- User Profile -->
      <div class="user-profile" (click)="goTo('/perfil')">
        <div class="user-info">
          <div class="user-name">{{ userName() || 'Usuario' }}</div>
          <div class="user-role">
            {{ canAccessGeneralStats() ? 'Administrador' : 'Usuario' }}
          </div>
        </div>
        <div class="user-avatar">
          <ion-icon name="person-outline"></ion-icon>
        </div>
      </div>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="dashboard-content">
  <!-- Pull to Refresh -->
  <ion-refresher slot="fixed" (ionRefresh)="refreshStats($event)">
    <ion-refresher-content
      pulling-icon="arrow-down-outline"
      pulling-text="Desliza para actualizar"
      refreshing-spinner="circular"
      refreshing-text="Actualizando datos..."
    >
    </ion-refresher-content>
  </ion-refresher>

  <div class="dashboard-container">
    <!-- Welcome Section -->
    <div class="welcome-section">
      <div class="welcome-content">
        <h1 class="welcome-title">
          Hola, <span class="welcome-name">{{ userName() || 'Usuario' }}</span>
        </h1>
        <p class="welcome-subtitle">
          Aquí tienes un resumen de tu actividad reciente
        </p>
      </div>
      <div class="welcome-date">
        <ion-icon name="calendar-outline" class="date-icon"></ion-icon>
        <span>{{ getCurrentDate() }}</span>
      </div>
    </div>

    <!-- Quick Stats Overview -->
    <div
      class="stats-overview"
      *ngIf="!isLoadingStats() && formattedStats(); else loadingStats"
    >
      <div class="stats-header">
        <h2>Resumen de Actividad</h2>
        <div class="stats-period">
          <ion-icon name="time-outline"></ion-icon>
          <span>Últimos 30 días</span>
        </div>
      </div>

      <div class="stats-grid">
        <!-- Total Consultas -->
        <div class="stat-card primary">
          <div class="stat-icon">
            <ion-icon name="analytics-outline"></ion-icon>
          </div>
          <div class="stat-content">
            <div class="stat-value">
              {{ formattedStats()?.totalConsultas || 0 }}
            </div>
            <div class="stat-label">Total</div>
          </div>
        </div>

        <!-- Consultas Exitosas -->
        <div class="stat-card success">
          <div class="stat-icon">
            <ion-icon name="checkmark-circle-outline"></ion-icon>
          </div>
          <div class="stat-content">
            <div class="stat-value">
              {{ formattedStats()?.consultasExitosas || 0 }}
            </div>
            <div class="stat-label">Exitosas</div>
          </div>
        </div>

        <!-- Consultas con Error -->
        <div class="stat-card warning">
          <div class="stat-icon">
            <ion-icon name="alert-circle-outline"></ion-icon>
          </div>
          <div class="stat-content">
            <div class="stat-value">
              {{ formattedStats()?.consultasConError || 0 }}
            </div>
            <div class="stat-label">Errores</div>
          </div>
        </div>

        <!-- Última Actividad -->
        <div class="stat-card info">
          <div class="stat-icon">
            <ion-icon name="time-outline"></ion-icon>
          </div>
          <div class="stat-content">
            <div class="stat-value-small">
              {{ getRelativeTime(formattedStats()?.ultimaConsulta) }}
            </div>
            <div class="stat-label">Última</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading State -->
    <ng-template #loadingStats>
      <div class="loading-section">
        <ion-spinner name="dots" class="loading-spinner"></ion-spinner>
        <p class="loading-text">Cargando estadísticas...</p>
      </div>
    </ng-template>

    <!-- My Location Section - COMPACTO Y MODERNO -->
    <div class="location-section-compact" *ngIf="!isLoadingLocationHistory()">
      <!-- Loading State for Location -->
      <div *ngIf="isLoadingLocationHistory()" class="loading-section compact">
        <ion-spinner name="dots" class="loading-spinner"></ion-spinner>
        <p class="loading-text">Cargando ubicación...</p>
      </div>

      <!-- Error State for Location -->
      <div *ngIf="hasLocationError()" class="error-section compact">
        <div class="error-content">
          <ion-icon name="alert-circle-outline" class="error-icon"></ion-icon>
          <div class="error-text">
            <p class="error-message">{{ locationErrorMessage() }}</p>
            <ion-button fill="clear" size="small" (click)="loadUserLocationHistory()">
              <ion-icon name="refresh-outline" slot="start"></ion-icon>
              Reintentar
            </ion-button>
          </div>
        </div>
      </div>

      <!-- Location Content -->
      <div class="location-content-compact" *ngIf="userLocationHistory() && !hasLocationError()">
        <!-- Compact Location Card -->
        <div class="location-card-compact" 
             *ngIf="userLocationHistory(); else noLocationCardCompact"
             (click)="openMyLocationHistoryModal()">
          <div class="location-card-header">
            <div class="location-icon-wrapper">
              <ion-icon name="location" class="location-icon"></ion-icon>
            </div>
            <div class="location-info">
              <h3 class="location-name">{{ userLocationHistory()?.currentLocation?.locationName || 'Sin ubicación asignada' }}</h3>
              <div class="location-stats">
                <span class="stat-badge">
                  <ion-icon name="analytics-outline"></ion-icon>
                  {{ userLocationHistory()?.consultationStats?.totalConsultas || 0 }} consultas
                </span>
              </div>
            </div>
            <ion-button 
              fill="clear" 
              size="small"
              class="location-action-btn"
              (click)="$event.stopPropagation(); openMyLocationHistoryModal()">
              <ion-icon name="chevron-forward-outline" slot="icon-only"></ion-icon>
            </ion-button>
          </div>
        </div>

        <!-- No Location Card Compact -->
        <ng-template #noLocationCardCompact>
          <div class="no-location-card-compact" (click)="openMyLocationHistoryModal()">
            <div class="no-location-content">
              <div class="no-location-icon-wrapper">
                <ion-icon name="location" class="no-location-icon"></ion-icon>
              </div>
              <div class="no-location-text">
                <h4>Sin Ubicación</h4>
                <p>No hay ubicación asignada</p>
              </div>
            </div>
          </div>
        </ng-template>
      </div>
    </div>

    <!-- Main Services Grid -->
    <div class="services-section">
      <div class="section-header">
        <h2>Servicios Disponibles</h2>
        <p>Accede a todas las funcionalidades del sistema</p>
      </div>

      <div class="services-grid">
        <!-- Estado de Cuenta -->
        <div class="service-card blue" (click)="goTo('/estado-cuenta')">
          <div class="service-header">
            <div class="service-icon">
              <ion-icon name="document-text-outline"></ion-icon>
            </div>
            <div class="service-badge">
              {{ formattedStats()?.consultasICS || 0 }}
            </div>
          </div>
          <div class="service-content">
            <h3>Estado de Cuenta</h3>
            <p>Consulta tu estado financiero actual</p>
          </div>
          <div class="service-footer">
            <span class="service-status active">Disponible</span>
            <ion-icon
              name="arrow-forward-outline"
              class="service-arrow"
            ></ion-icon>
          </div>
        </div>

        <!-- Estado de Cuenta con Amnistía -->
        <div
          class="service-card green"
          (click)="goTo('/estado-cuenta-amnistia')"
        >
          <div class="service-header">
            <div class="service-icon">
              <ion-icon name="shield-checkmark-outline"></ion-icon>
            </div>
            <div class="service-badge new">Nuevo</div>
          </div>
          <div class="service-content">
            <h3>EC con Amnistía</h3>
            <p>Estado con beneficios de amnistía fiscal</p>
          </div>
          <div class="service-footer">
            <span class="service-status active">Disponible</span>
            <ion-icon
              name="arrow-forward-outline"
              class="service-arrow"
            ></ion-icon>
          </div>
        </div>

        <!-- Volumen de Ventas -->
        <div class="service-card purple" (click)="goTo('/consulta-ics')">
          <div class="service-header">
            <div class="service-icon">
              <ion-icon name="bar-chart-outline"></ion-icon>
            </div>
            <div class="service-badge">
              {{ formattedStats()?.consultasEC || 0 }}
            </div>
          </div>
          <div class="service-content">
            <h3>Volumen de Ventas</h3>
            <p>Análisis detallado de ventas</p>
          </div>
          <div class="service-footer">
            <span class="service-status active">Disponible</span>
            <ion-icon
              name="arrow-forward-outline"
              class="service-arrow"
            ></ion-icon>
          </div>
        </div>

        <!-- Volumen de Ventas con Amnistía -->
        <div
          class="service-card orange"
          (click)="goTo('/consulta-ics-amnistia')"
        >
          <div class="service-header">
            <div class="service-icon">
              <ion-icon name="trending-up-outline"></ion-icon>
            </div>
            <div class="service-badge new">Nuevo</div>
          </div>
          <div class="service-content">
            <h3>VV con Amnistía</h3>
            <p>Reportes con beneficios aplicados</p>
          </div>
          <div class="service-footer">
            <span class="service-status active">Disponible</span>
            <ion-icon
              name="arrow-forward-outline"
              class="service-arrow"
            ></ion-icon>
          </div>
        </div>
      </div>
    </div>

    <!-- Configuration & Tools -->
    <div class="tools-section">
      <div class="section-header">
        <h2>Configuraciones</h2>
        <p>Gestiona tu cuenta y preferencias</p>
      </div>

      <div class="tools-grid">
        <!-- Mi Perfil -->
        <div class="tool-item" (click)="goTo('/perfil')">
          <div class="tool-icon blue">
            <ion-icon name="person-outline"></ion-icon>
          </div>
          <div class="tool-content">
            <h4>Mi Perfil</h4>
            <p>Información personal y configuración</p>
          </div>
          <ion-icon
            name="chevron-forward-outline"
            class="tool-arrow"
          ></ion-icon>
        </div>

        <!-- Historial de Ubicaciones (Solo USER-ADMIN) -->
        <div class="tool-item" (click)="goToLocationHistory()" *ngIf="canAccessGeneralStats()">
          <div class="tool-icon orange">
            <ion-icon name="location-outline"></ion-icon>
          </div>
          <div class="tool-content">
            <h4>Historial de Ubicaciones</h4>
            <p>Ver historial de todos los usuarios</p>
          </div>
          <ion-icon
            name="chevron-forward-outline"
            class="tool-arrow"
          ></ion-icon>
        </div>

        <!-- Bluetooth -->
        <div class="tool-item" (click)="goTo('/bluetooth')">
          <div class="tool-icon purple">
            <ion-icon name="bluetooth-outline"></ion-icon>
          </div>
          <div class="tool-content">
            <h4>Bluetooth</h4>
            <p>Configuración de dispositivos</p>
          </div>
          <ion-icon
            name="chevron-forward-outline"
            class="tool-arrow"
          ></ion-icon>
        </div>

        <!-- Admin Tools -->
        <div
          class="tool-item"
          *ngIf="canAccessGeneralStats()"
          (click)="goToGeneralStats()"
        >
          <div class="tool-icon green">
            <ion-icon name="analytics-outline"></ion-icon>
          </div>
          <div class="tool-content">
            <h4>Estadísticas Generales</h4>
            <p>Panel de administración completo</p>
          </div>
          <div class="admin-badge">Admin</div>
          <ion-icon
            name="chevron-forward-outline"
            class="tool-arrow"
          ></ion-icon>
        </div>

        <!-- System Logs -->
        <div
          class="tool-item"
          *ngIf="canAccessGeneralStats()"
          (click)="goToActivityLogs()"
        >
          <div class="tool-icon orange">
            <ion-icon name="eye-outline"></ion-icon>
          </div>
          <div class="tool-content">
            <h4>Logs del Sistema</h4>
            <p>Monitoreo y auditoría</p>
          </div>
          <div class="admin-badge">Admin</div>
          <ion-icon
            name="chevron-forward-outline"
            class="tool-arrow"
          ></ion-icon>
        </div>


      </div>
    </div>
  </div>
</ion-content>
