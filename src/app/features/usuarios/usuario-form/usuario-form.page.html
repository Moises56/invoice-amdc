<ion-header>
  <ion-toolbar class="municipal-toolbar">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/usuarios"></ion-back-button>
    </ion-buttons>
    <ion-title>
      {{ isEditing() ? 'Editar Usuario' : 'Nuevo Usuario' }}
    </ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="goBack()" fill="clear" class="close-btn-modern">
        <ion-icon name="close-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="modern-form-content">
  <div class="form-container">
    <form [formGroup]="form" (ngSubmit)="onSubmit()">
      
      <!-- Grid de cards responsive -->
      <div class="cards-grid">
        <!-- Información básica -->
        <ion-card class="glass-card">
          <ion-card-header class="card-header-modern">
            <ion-card-title class="card-title-glass">
              <div class="title-icon">
                <ion-icon name="person-outline"></ion-icon>
              </div>
              Información Básica
            </ion-card-title>
          </ion-card-header>
        
        <ion-card-content class="card-content-modern">
          <!-- Nombre -->
          <ion-item class="input-glass" lines="none">
            <ion-label position="stacked" class="label-modern">
              Nombre *
            </ion-label>
            <ion-input
              formControlName="nombre"
              placeholder="Ingrese el nombre"
              [class.is-invalid]="hasError('nombre')"
              class="input-modern">
            </ion-input>
          </ion-item>
          <div *ngIf="hasError('nombre')" class="error-message">
            {{ getErrorMessage('nombre') }}
          </div>

          <!-- Apellido -->
          <ion-item class="input-glass" lines="none">
            <ion-label position="stacked" class="label-modern">
              Apellido *
            </ion-label>
            <ion-input
              formControlName="apellido"
              placeholder="Ingrese el apellido"
              [class.is-invalid]="hasError('apellido')"
              class="input-modern">
            </ion-input>
          </ion-item>
          <div *ngIf="hasError('apellido')" class="error-message">
            {{ getErrorMessage('apellido') }}
          </div>

          <!-- Email -->
          <ion-item class="input-glass" lines="none">
            <ion-label position="stacked" class="label-modern">
              Correo Electrónico *
            </ion-label>
            <ion-input
              formControlName="correo"
              type="email"
              placeholder="usuario@ejemplo.com"
              [class.is-invalid]="hasError('correo')"
              class="input-modern">
            </ion-input>
          </ion-item>
          <div *ngIf="hasError('correo')" class="error-message">
            {{ getErrorMessage('correo') }}
          </div>

          <!-- Username -->
          <ion-item class="input-glass" lines="none">
            <ion-label position="stacked" class="label-modern">
              Usuario *
            </ion-label>
            <ion-input
              formControlName="username"
              placeholder="Nombre de usuario"
              [class.is-invalid]="hasError('username')"
              class="input-modern">
            </ion-input>
          </ion-item>
          <div *ngIf="hasError('username')" class="error-message">
            {{ getErrorMessage('username') }}
          </div>

          <!-- DNI -->
          <ion-item class="input-glass" lines="none">
            <ion-label position="stacked" class="label-modern">
              DNI *
            </ion-label>
            <ion-input
              formControlName="dni"
              placeholder="Número de identidad"
              [class.is-invalid]="hasError('dni')"
              class="input-modern">
            </ion-input>
          </ion-item>
          <div *ngIf="hasError('dni')" class="error-message">
            {{ getErrorMessage('dni') }}
          </div>

          <!-- Teléfono -->
          <ion-item class="input-glass" lines="none">
            <ion-label position="stacked" class="label-modern">
              Teléfono
            </ion-label>
            <ion-input
              formControlName="telefono"
              type="tel"
              placeholder="Número de teléfono"
              class="input-modern">
            </ion-input>
          </ion-item>

          <!-- Gerencia -->
          <ion-item class="input-glass" lines="none">
            <ion-label position="stacked" class="label-modern">
              Gerencia
            </ion-label>
            <ion-input
              formControlName="gerencia"
              placeholder="Gerencia o departamento"
              class="input-modern">
            </ion-input>
          </ion-item>

          <!-- Número de empleado -->
          <ion-item class="input-glass" lines="none">
            <ion-label position="stacked" class="label-modern">
              Número de Empleado
            </ion-label>
            <ion-input
              formControlName="numero_empleado"
              type="number"
              placeholder="Número de empleado"
              class="input-modern">
            </ion-input>
          </ion-item>
        </ion-card-content>
        </ion-card>

        <!-- Configuración de acceso -->
        <ion-card class="glass-card">
          <ion-card-header class="card-header-modern">
            <ion-card-title class="card-title-glass">
              <div class="title-icon">
                <ion-icon name="key-outline"></ion-icon>
              </div>
              Configuración de Acceso
            </ion-card-title>
          </ion-card-header>
        
        <ion-card-content class="card-content-modern">
          <!-- Rol -->
          <ion-item class="input-glass" lines="none">
            <ion-label position="stacked" class="label-modern">
              Rol *
            </ion-label>
            <ion-select
              formControlName="role"
              placeholder="Seleccione un rol"
              [class.is-invalid]="hasError('role')"
              class="input-modern">
              <ion-select-option *ngFor="let role of availableRoles" [value]="role">
                {{ getRoleText(role) }}
              </ion-select-option>
            </ion-select>
          </ion-item>
          <div *ngIf="hasError('role')" class="error-message">
            {{ getErrorMessage('role') }}
          </div>

          <!-- Password -->
          <ion-item class="input-glass" lines="none">
            <ion-label position="stacked" class="label-modern">
              Contraseña {{ isEditing() ? '(dejar vacío para mantener actual)' : '*' }}
            </ion-label>
            <ion-input
              formControlName="password"
              type="password"
              placeholder="Ingrese la contraseña"
              [class.is-invalid]="hasError('password')"
              class="input-modern">
            </ion-input>
          </ion-item>
          <div *ngIf="hasError('password')" class="error-message">
            {{ getErrorMessage('password') }}
          </div>

          <!-- Confirmar Password -->
          <ion-item 
            *ngIf="form.get('password')?.value" 
            class="input-glass" 
            lines="none">
            <ion-label position="stacked" class="label-modern">
              Confirmar Contraseña *
            </ion-label>
            <ion-input
              formControlName="confirmPassword"
              type="password"
              placeholder="Confirme la contraseña"
              [class.is-invalid]="hasError('confirmPassword')"
              class="input-modern">
            </ion-input>
          </ion-item>
          <div *ngIf="hasError('confirmPassword')" class="error-message">
            {{ getErrorMessage('confirmPassword') }}
          </div>

          <!-- Estado activo -->
          <ion-item class="input-glass toggle-item" lines="none">
            <ion-label class="label-modern">
              Usuario Activo
            </ion-label>
            <ion-toggle 
              formControlName="isActive" 
              slot="end"
              color="primary">
            </ion-toggle>
          </ion-item>
        </ion-card-content>
        </ion-card>
      </div>

      <!-- Botones de acción -->
      <div class="action-buttons">
        <ion-button 
          fill="solid" 
          (click)="goBack()"
          class="secondary-btn">
          <ion-icon name="arrow-back-outline" slot="start"></ion-icon>
          Cancelar
        </ion-button>
        
        <ion-button 
          fill="solid"
          type="submit"
          [disabled]="form.invalid || isLoading()"
          class="primary-btn">
          <div *ngIf="isLoading()" class="loading-spinner">
            <ion-spinner name="crescent"></ion-spinner>
            <span>Guardando...</span>
          </div>
          <div *ngIf="!isLoading()" style="display: flex; align-items: center; gap: 0.5rem;">
            <ion-icon name="save-outline"></ion-icon>
            <span>{{ isEditing() ? 'Actualizar' : 'Crear' }} Usuario</span>
          </div>
        </ion-button>
      </div>
    </form>
  </div>
</ion-content>
