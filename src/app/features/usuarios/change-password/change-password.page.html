<ion-header>
  <ion-toolbar class="municipal-toolbar">
    <ion-buttons slot="start">
      <ion-button (click)="close()" fill="clear">
        <ion-icon name="close-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title class="text-white font-semibold">
      Cambiar Contraseña
    </ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="bg-gray-50">
  <div class="p-4">
    <form [formGroup]="form" (ngSubmit)="onSubmit()">
      
      <!-- Información de seguridad -->
      <ion-card class="shadow-sm mb-4">
        <ion-card-header class="pb-2">
          <ion-card-title class="text-lg text-gray-800 flex items-center">
            <ion-icon name="key-outline" class="mr-2 text-primary"></ion-icon>
            {{ isAdmin ? 'Restablecer Contraseña' : 'Cambiar Contraseña' }}
          </ion-card-title>
        </ion-card-header>
        
        <ion-card-content class="pt-0">
          <!-- Contraseña actual (solo para usuarios no admin) -->
          <ion-item 
            *ngIf="!isAdmin"
            class="mb-3 rounded-lg custom-input" 
            lines="none">
            <ion-label position="stacked" class="text-sm font-medium text-gray-700">
              Contraseña Actual *
            </ion-label>
            <ion-input
              formControlName="currentPassword"
              type="password"
              placeholder="Ingrese su contraseña actual"
              [class.is-invalid]="hasError('currentPassword')"
              class="mt-1">
            </ion-input>
          </ion-item>
          <div *ngIf="hasError('currentPassword')" class="error-message">
            {{ getErrorMessage('currentPassword') }}
          </div>

          <!-- Nueva contraseña -->
          <ion-item class="mb-3 rounded-lg custom-input" lines="none">
            <ion-label position="stacked" class="text-sm font-medium text-gray-700">
              Nueva Contraseña *
            </ion-label>
            <ion-input
              formControlName="newPassword"
              type="password"
              placeholder="Ingrese la nueva contraseña"
              [class.is-invalid]="hasError('newPassword')"
              class="mt-1">
            </ion-input>
          </ion-item>
          <div *ngIf="hasError('newPassword')" class="error-message">
            {{ getErrorMessage('newPassword') }}
          </div>

          <!-- Indicador de fuerza de contraseña -->
          <div class="password-strength mt-2" *ngIf="form.get('newPassword')?.value">
            <div class="strength-meter" [attr.data-strength]="getPasswordStrength()">
              <div class="strength-fill"></div>
            </div>
            <span class="strength-text" [attr.data-strength]="getPasswordStrength()">
              Fuerza: {{ getPasswordStrengthText() }}
            </span>
          </div>

          <!-- Confirmar nueva contraseña -->
          <ion-item class="mb-3 rounded-lg custom-input" lines="none">
            <ion-label position="stacked" class="text-sm font-medium text-gray-700">
              Confirmar Nueva Contraseña *
            </ion-label>
            <ion-input
              formControlName="confirmPassword"
              type="password"
              placeholder="Confirme la nueva contraseña"
              [class.is-invalid]="hasError('confirmPassword')"
              class="mt-1">
            </ion-input>
          </ion-item>
          <div *ngIf="hasError('confirmPassword')" class="error-message">
            {{ getErrorMessage('confirmPassword') }}
          </div>

          <!-- Información de seguridad -->
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mt-4">
            <div class="flex items-start">
              <ion-icon name="lock-closed-outline" class="text-blue-500 mr-2 mt-1"></ion-icon>
              <div class="text-sm text-blue-700">
                <p class="font-medium mb-1">Requisitos de contraseña:</p>
                <ul class="list-disc list-inside space-y-1 text-xs">
                  <li class="password-req" [class.met]="hasMinLength()">
                    Mínimo 8 caracteres
                  </li>
                  <li class="password-req" [class.met]="hasUpperCase()">
                    Al menos una letra mayúscula
                  </li>
                  <li class="password-req" [class.met]="hasLowerCase()">
                    Al menos una letra minúscula
                  </li>
                  <li class="password-req" [class.met]="hasNumbers()">
                    Al menos un número
                  </li>
                  <li class="password-req" [class.met]="hasSymbols()">
                    Al menos un símbolo (especiales)
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Botones de acción -->
      <div class="flex gap-3 mt-6">
        <ion-button 
          expand="block" 
          fill="outline" 
          color="medium"
          (click)="close()"
          class="flex-1">
          <ion-icon name="close-outline" slot="start"></ion-icon>
          Cancelar
        </ion-button>
        
        <ion-button 
          expand="block" 
          type="submit"
          [disabled]="form.invalid || isLoading()"
          class="flex-1">
          <ion-spinner *ngIf="isLoading()" name="crescent" slot="start"></ion-spinner>
          <ion-icon *ngIf="!isLoading()" name="save-outline" slot="start"></ion-icon>
          {{ isAdmin ? 'Restablecer' : 'Cambiar' }}
        </ion-button>
      </div>

      <!-- Debug info (solo para desarrollo) -->
      <div class="mt-4 p-3 bg-gray-100 rounded text-xs" *ngIf="false">
        <p><strong>Form Valid:</strong> {{ form.valid }}</p>
        <p><strong>Form Errors:</strong> {{ getFormErrors() }}</p>
        <p><strong>Is Admin:</strong> {{ isAdmin }}</p>
      </div>
    </form>
  </div>
</ion-content>
