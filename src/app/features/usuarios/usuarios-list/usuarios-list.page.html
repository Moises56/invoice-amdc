<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>Usuarios</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="createUser()" fill="clear">
        <ion-icon name="add-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="users-page">    <!-- Header fijo con controles -->
    <div class="sticky-header">
      <!-- Título y estadísticas -->
      <div class="header-stats">
        <h1>Gestión de Usuarios</h1>
        <div class="stats-cards">
          <div class="stat-item">
            <ion-icon name="people-outline"></ion-icon>
            <div>
              <span class="stat-number">{{ userStats()?.total || totalItems() }}</span>
              <span class="stat-label">Total</span>
            </div>
          </div>
          <div class="stat-item success">
            <ion-icon name="checkmark-circle-outline"></ion-icon>
            <div>
              <span class="stat-number">{{ userStats()?.active || filteredByStatus()(true).length }}</span>
              <span class="stat-label">Activos</span>
            </div>
          </div>
          <div class="stat-item pending">
            <ion-icon name="close-circle-outline"></ion-icon>
            <div>
              <span class="stat-number">{{ userStats()?.inactive || filteredByStatus()(false).length }}</span>
              <span class="stat-label">Inactivos</span>
            </div>
          </div>
          <div class="stat-item admin">
            <ion-icon name="shield-outline"></ion-icon>
            <div>
              <span class="stat-number">{{ userStats()?.byRole?.ADMIN || filteredByRole()(Role.ADMIN).length }}</span>
              <span class="stat-label">Admins</span>
            </div>
          </div>
        </div>
      </div>

    <!-- Buscador y filtros -->
    <div class="search-filters">
      <ion-searchbar 
        [(ngModel)]="searchTerm"
        (ionInput)="onSearch($event)"
        placeholder="Buscar por nombre, email, usuario..."
        debounce="500"
        show-clear-button="focus">
      </ion-searchbar>
      
      <div class="filters-row">
        <ion-item class="filter-item">
          <ion-select 
            [(ngModel)]="selectedRole"
            (ionChange)="onRoleChange($event)"
            placeholder="Rol"
            interface="popover">
            <ion-select-option value="">Todos los roles</ion-select-option>
            <ion-select-option [value]="Role.ADMIN">Administrador</ion-select-option>
            <ion-select-option [value]="Role.MARKET">Gerente de Mercado</ion-select-option>
            <ion-select-option [value]="Role.USER">Usuario</ion-select-option>
          </ion-select>
        </ion-item>

        <ion-item class="filter-item">
          <ion-select 
            [(ngModel)]="selectedStatus"
            (ionChange)="onStatusChange($event)"
            placeholder="Estado"
            interface="popover">
            <ion-select-option value="">Todos los estados</ion-select-option>
            <ion-select-option [value]="true">Activos</ion-select-option>
            <ion-select-option [value]="false">Inactivos</ion-select-option>
          </ion-select>
        </ion-item>

        <ion-item class="filter-item" *ngIf="availableGerencias().length > 0">
          <ion-select 
            [(ngModel)]="selectedGerencia"
            (ionChange)="onGerenciaChange($event)"
            placeholder="Gerencia"
            interface="popover">
            <ion-select-option value="">Todas las gerencias</ion-select-option>
            <ion-select-option [value]="gerencia" *ngFor="let gerencia of availableGerencias()">{{ gerencia }}</ion-select-option>
          </ion-select>
        </ion-item>

        <ion-button 
          fill="clear" 
          (click)="clearFilters()"
          class="clear-filters-btn">
          <ion-icon name="refresh-outline"></ion-icon>
        </ion-button>
      </div>
    </div>
  </div>

  <!-- Refresher -->
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content
      pulling-icon="chevron-down-circle-outline"
      pulling-text="Desliza para actualizar"
      refreshing-spinner="circles"
      refreshing-text="Actualizando...">
    </ion-refresher-content>
  </ion-refresher>

  <!-- Loading spinner -->
  <div *ngIf="loading()" class="loading-container">
    <ion-spinner name="crescent" color="primary"></ion-spinner>
    <p>Cargando usuarios...</p>
  </div>

  <!-- Lista de usuarios -->
  <div *ngIf="!loading()" class="users-content">
    <!-- Grid de usuarios -->
    <div class="users-grid">
      <ion-grid>
        <ion-row>
          <ion-col 
            *ngFor="let user of usuarios(); trackBy: trackByUser"
            size="12" 
            size-sm="6" 
            size-md="4" 
            size-lg="3">
            <ion-card 
              class="user-card"
              [class.admin]="user.role === Role.ADMIN"
              [class.market]="user.role === Role.MARKET"
              [class.user]="user.role === Role.USER"
              [class.inactive]="!user.isActive">
              <!-- Removido el (click)="viewUser(user)" para evitar navegación no deseada -->
              
              <ion-card-header>
                <div class="user-header">
                  <div class="user-avatar">
                    {{ getAvatarInitials(user) }}
                  </div>
                  <div class="user-info">
                    <ion-card-title>{{ getFullName(user) }}</ion-card-title>
                    <ion-card-subtitle>{{ user.correo || user.email || user.username }}</ion-card-subtitle>
                  </div>
                </div>
                <div class="user-badges">
                  <div 
                    class="role-badge"
                    [class.admin]="user.role === Role.ADMIN"
                    [class.market]="user.role === Role.MARKET"
                    [class.user]="user.role === Role.USER">
                    {{ getRoleText(user.role) }}
                  </div>
                </div>
              </ion-card-header>

              <ion-card-content>
                <div class="user-details">
                  <!-- Estado -->
                  <div class="detail-row">
                    <ion-icon name="radio-button-on-outline"></ion-icon>
                    <div class="detail-content">
                      <span class="detail-label">Estado</span>
                      <span class="detail-value status">
                        <span class="status-indicator" [class.inactive]="!user.isActive"></span>
                        {{ getUserStatus(user).text }}
                      </span>
                    </div>
                  </div>

                  <!-- Email -->
                  <div class="detail-row" *ngIf="user.correo || user.email">
                    <ion-icon name="mail-outline"></ion-icon>
                    <div class="detail-content">
                      <span class="detail-label">Email</span>
                      <span class="detail-value">{{ user.correo || user.email }}</span>
                    </div>
                  </div>

                  <!-- Teléfono -->
                  <div class="detail-row" *ngIf="user.telefono || user.phone">
                    <ion-icon name="call-outline"></ion-icon>
                    <div class="detail-content">
                      <span class="detail-label">Teléfono</span>
                      <span class="detail-value">{{ user.telefono || user.phone }}</span>
                    </div>
                  </div>

                  <!-- Username -->
                  <div class="detail-row" *ngIf="user.username">
                    <ion-icon name="at-outline"></ion-icon>
                    <div class="detail-content">
                      <span class="detail-label">Usuario</span>
                      <span class="detail-value">{{ user.username }}</span>
                    </div>
                  </div>

                  <!-- Último acceso -->
                  <div class="detail-row" *ngIf="user.lastLogin">
                    <ion-icon name="time-outline"></ion-icon>
                    <div class="detail-content">
                      <span class="detail-label">Último acceso</span>
                      <span class="detail-value">{{ formatLastLogin(user.lastLogin) }}</span>
                    </div>
                  </div>
                </div>

                <!-- Acciones -->
                <div class="user-actions">
                  <ion-button 
                    class="view-button"
                    size="small" 
                    fill="outline"
                    (click)="viewUser(user)">
                    <ion-icon name="eye-outline" slot="start"></ion-icon>
                    Ver
                  </ion-button>
                  <ion-button 
                    class="edit-button"
                    size="small" 
                    (click)="editUser(user)">
                    <ion-icon name="create-outline" slot="start"></ion-icon>
                    Editar
                  </ion-button>
                  <ion-button 
                    class="password-button"
                    size="small" 
                    fill="outline"
                    color="warning"
                    (click)="resetPassword(user)">
                    <ion-icon name="key-outline" slot="start"></ion-icon>
                    Contraseña
                  </ion-button>
                  <ion-button 
                    class="toggle-button"
                    size="small" 
                    fill="outline"
                    [color]="user.isActive ? 'danger' : 'success'"
                    (click)="toggleUserStatus(user)">
                    <ion-icon 
                      [name]="user.isActive ? 'close-circle-outline' : 'checkmark-circle-outline'"
                      slot="start">
                    </ion-icon>
                    {{ user.isActive ? 'Desactivar' : 'Activar' }}
                  </ion-button>
                </div>
              </ion-card-content>
            </ion-card>
          </ion-col>
        </ion-row>
      </ion-grid>
    </div>

    <!-- Estado vacío -->
    <div *ngIf="usuarios().length === 0" class="empty-state">
      <ion-icon name="people-outline" size="large"></ion-icon>
      <h3>No se encontraron usuarios</h3>
      <p>No hay usuarios que coincidan con los filtros seleccionados.</p>
      <ion-button 
        (click)="clearFilters()" 
        fill="outline">
        Limpiar filtros
      </ion-button>
    </div>
  </div>

  <!-- Infinite scroll -->
  <ion-infinite-scroll 
    threshold="100px" 
    (ionInfinite)="loadMore($event)"
    [disabled]="currentPage() >= totalPages()">
    <ion-infinite-scroll-content
      loading-spinner="bubbles"
      loading-text="Cargando más usuarios...">
    </ion-infinite-scroll-content>
  </ion-infinite-scroll>

  <!-- FAB para crear nuevo usuario -->
  <ion-fab vertical="bottom" horizontal="end" slot="fixed">
    <ion-fab-button (click)="createUser()" color="primary">
      <ion-icon name="add-outline"></ion-icon>
    </ion-fab-button>
  </ion-fab>
</ion-content>
