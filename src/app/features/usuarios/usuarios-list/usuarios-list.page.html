<ion-header>
  <ion-toolbar class="municipal-toolbar">
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title class="text-white font-semibold">Usuarios</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="loadUsuarios(true)">
        <ion-icon name="refresh-outline" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="bg-gray-50">
  <!-- Refresh -->
  <ion-refresher slot="fixed" (ionRefresh)="onRefresh($event)">
    <ion-refresher-content
      pulling-icon="chevron-down-circle-outline"
      pulling-text="Desliza para actualizar"
      refreshing-spinner="circles"
      refreshing-text="Actualizando...">
    </ion-refresher-content>
  </ion-refresher>

  <!-- Buscador -->
  <div class="p-4 bg-white border-b border-gray-200">
    <ion-searchbar
      placeholder="Buscar usuarios..."
      [debounce]="300"
      (ionInput)="onSearchChange($event)"
      class="custom-searchbar">
    </ion-searchbar>
  </div>

  <!-- Lista de usuarios -->
  <div class="p-4" *ngIf="!loading(); else loadingTemplate">
    <ion-list class="rounded-lg shadow-sm bg-white">
      <ion-item 
        *ngFor="let user of filteredUsuarios(); trackBy: trackByUserId"
        class="user-item border-b border-gray-100 last:border-0"
        [class.opacity-50]="!user.isActive">
        
        <!-- Avatar -->
        <ion-avatar slot="start" class="w-12 h-12">
          <div class="w-full h-full bg-primary rounded-full flex items-center justify-center">
            <ion-icon name="person-outline" class="text-white text-xl"></ion-icon>
          </div>
        </ion-avatar>

        <!-- Información del usuario -->
        <ion-label class="py-3">
          <div class="flex justify-between items-start">
            <div class="flex-1">
              <h3 class="font-semibold text-gray-800 text-base">{{ user.name }}</h3>
              <p class="text-sm text-gray-500 mt-1">{{ user.email }}</p>
              
              <!-- Chips de rol y estado -->
              <div class="flex gap-2 mt-2">
                <ion-chip [color]="getRoleColor(user.role)" class="text-xs">
                  <ion-label>{{ getRoleText(user.role) }}</ion-label>
                </ion-chip>
                
                <ion-badge 
                  [color]="user.isActive ? 'success' : 'danger'"
                  class="text-xs">
                  {{ user.isActive ? 'Activo' : 'Inactivo' }}
                </ion-badge>
              </div>
            </div>

            <!-- Botón de opciones -->
            <ion-button 
              fill="clear" 
              size="small"
              (click)="showUserOptions(user)"
              class="ml-2">
              <ion-icon name="ellipsis-vertical-outline" slot="icon-only"></ion-icon>
            </ion-button>
          </div>

          <!-- Información adicional -->          <div class="mt-2 text-xs text-gray-400">
            <span *ngIf="user.market">Mercado: {{ user.market.nombre_mercado }}</span>
            <span *ngIf="user.lastLogin" class="ml-2">
              Último acceso: {{ user.lastLogin | date:'short' }}
            </span>
          </div>
        </ion-label>
      </ion-item>

      <!-- Mensaje si no hay usuarios -->
      <div *ngIf="filteredUsuarios().length === 0" class="text-center py-12">
        <ion-icon name="people-outline" class="text-6xl text-gray-300 mb-4"></ion-icon>
        <h3 class="text-lg font-medium text-gray-500 mb-2">No hay usuarios</h3>
        <p class="text-sm text-gray-400">
          {{ searchText() ? 'No se encontraron usuarios con ese criterio' : 'Comienza agregando el primer usuario' }}
        </p>
      </div>
    </ion-list>
  </div>

  <!-- Loading template -->
  <ng-template #loadingTemplate>
    <div class="p-4">
      <ion-list class="rounded-lg shadow-sm bg-white">
        <ion-item *ngFor="let item of [1,2,3,4,5]" class="border-b border-gray-100">
          <ion-avatar slot="start">
            <ion-skeleton-text animated style="width: 100%; height: 100%"></ion-skeleton-text>
          </ion-avatar>
          <ion-label>
            <ion-skeleton-text animated style="width: 60%"></ion-skeleton-text>
            <ion-skeleton-text animated style="width: 80%"></ion-skeleton-text>
            <ion-skeleton-text animated style="width: 40%"></ion-skeleton-text>
          </ion-label>
        </ion-item>
      </ion-list>
    </div>
  </ng-template>

  <!-- Infinite scroll -->
  <ion-infinite-scroll 
    threshold="100px" 
    [disabled]="isInfiniteDisabled()"
    (ionInfinite)="onLoadMore($event)">
    <ion-infinite-scroll-content
      loading-spinner="bubbles"
      loading-text="Cargando más usuarios...">
    </ion-infinite-scroll-content>
  </ion-infinite-scroll>

  <!-- FAB para agregar usuario -->
  <ion-fab slot="fixed" vertical="bottom" horizontal="end">
    <ion-fab-button (click)="goToCreate()" class="shadow-lg">
      <ion-icon name="add-outline"></ion-icon>
    </ion-fab-button>
  </ion-fab>
</ion-content>
