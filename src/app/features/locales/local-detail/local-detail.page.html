<ion-header style="background:#5ccedf;">
  <ion-toolbar style="background:#5ccedf; min-height: env(safe-area-inset-top, 24px) + 56px; padding-top: env(safe-area-inset-top, 24px);" color="primary">
    <ion-buttons slot="start">
      <ion-back-button [defaultHref]="'/mercados/' + mercadoId()"></ion-back-button>
    </ion-buttons>
    <ion-title style="color:#fff; font-weight:bold;">{{ local()?.numero_local ? `Local ${local()?.numero_local}` : 'Detalle Local' }}</ion-title>    <ion-buttons slot="end">
      <ion-button (click)="verDetalleCompleto()">
        <ion-icon name="eye-outline"></ion-icon>
        Ver
      </ion-button>
      <ion-button *ngIf="canEditLocal()" (click)="editarLocal()">
        <ion-icon name="create-outline"></ion-icon>
      </ion-button>
      <ion-button (click)="refrescarLocal()">
        <ion-icon name="refresh-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="local-detail-content">
  <!-- Loading -->
  <div *ngIf="isLoading()" class="loading-container">
    <ion-spinner name="circular" color="primary"></ion-spinner>
    <p>Cargando información del local...</p>
  </div>

  <!-- Error -->
  <div *ngIf="error()" class="error-container">
    <ion-icon name="alert-circle-outline" color="danger"></ion-icon>
    <h3>Error al cargar el local</h3>
    <p>{{ error() }}</p>
    <ion-button fill="outline" (click)="cargarLocal()">Reintentar</ion-button>
  </div>

  <!-- Contenido Principal -->
  <div *ngIf="!isLoading() && !error() && local()" class="content-container">
    
    <!-- Información del Local -->
    <ion-card class="local-info-card m-2 shadow-md border-0 bg-white">
      <ion-card-header class="pb-2">
        <div class="iten-local flex items-center justify-between">
          <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center">
              <ion-icon name="storefront-outline" class="text-white text-sm"></ion-icon>
            </div>
            <div>
              <ion-card-title class="text-lg font-bold text-gray-800 leading-tight">
                Local {{ local()?.numero_local }}
              </ion-card-title>
              <ion-badge 
                [color]="getEstadoColor(local()?.estado_local || '')" 
                class="text-xs px-2 py-1 mt-1">
                {{ local()?.estado_local }}
              </ion-badge>
            </div>
          </div>
          
          <div class="local-actions" *ngIf="canEditLocal()">
            <ion-button 
              fill="clear" 
              size="small" 
              (click)="toggleEstadoLocal()"
              class="w-8 h-8">
              <ion-icon 
                [name]="local()?.estado_local === 'ACTIVO' ? 'pause-outline' : 'play-outline'"
                class="text-gray-600 text-sm">
              </ion-icon>
            </ion-button>
          </div>
        </div>
      </ion-card-header>
      
      <ion-card-content class="pt-0 px-4 pb-4">
        <div class="grid grid-cols-2 md:grid-cols-3 gap-3 text-sm">
          <!-- Propietario -->
          <div class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg">
            <ion-icon name="person-outline" class="text-emerald-500 text-base flex-shrink-0"></ion-icon>
            <div class="min-w-0 flex-1">
              <p class="text-xs text-gray-500 font-medium mb-0">Propietario</p>
              <p class="text-gray-800 font-medium text-xs truncate leading-tight">{{ local()?.propietario || 'No asignado' }}</p>
            </div>
          </div>

          <!-- Teléfono -->
          <div class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg">
            <ion-icon name="call-outline" class="text-blue-500 text-base flex-shrink-0"></ion-icon>
            <div class="min-w-0 flex-1">
              <p class="text-xs text-gray-500 font-medium mb-0">Teléfono</p>
              <p class="text-gray-800 font-medium text-xs leading-tight">{{ local()?.telefono || 'No registrado' }}</p>
            </div>
          </div>

          <!-- Tipo -->
          <div class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg">
            <ion-icon name="business-outline" class="text-purple-500 text-base flex-shrink-0"></ion-icon>
            <div class="min-w-0 flex-1">
              <p class="text-xs text-gray-500 font-medium mb-0">Tipo</p>
              <p class="text-gray-800 font-medium text-xs leading-tight">{{ local()?.tipo_local || 'No especificado' }}</p>
            </div>
          </div>

          <!-- Dirección -->
          <div class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg col-span-2 md:col-span-1">
            <ion-icon name="location-outline" class="text-orange-500 text-base flex-shrink-0"></ion-icon>
            <div class="min-w-0 flex-1">
              <p class="text-xs text-gray-500 font-medium mb-0">Dirección</p>
              <p class="text-gray-800 font-medium text-xs leading-tight">{{ local()?.direccion_local || 'No registrada' }}</p>
            </div>
          </div>

          <!-- Tarifa Mensual -->
          <div class="flex items-center gap-2 p-2 bg-green-50 rounded-lg border border-green-100">
            <ion-icon name="cash-outline" class="text-green-600 text-base flex-shrink-0"></ion-icon>
            <div class="min-w-0 flex-1">
              <p class="text-xs text-green-600 font-medium mb-0">Tarifa Mensual</p>
              <p class="text-green-700 font-bold text-sm leading-tight">L. {{ local()?.monto_mensual | currency:'':'':'1.2-2' }}</p>
            </div>
          </div>

          <!-- Fecha de Registro -->
          <div class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg">
            <ion-icon name="calendar-outline" class="text-indigo-500 text-base flex-shrink-0"></ion-icon>
            <div class="min-w-0 flex-1">
              <p class="text-xs text-gray-500 font-medium mb-0">Registro</p>
              <p class="text-gray-800 font-medium text-xs leading-tight">{{ local()?.createdAt | date:'dd/MM/yyyy' }}</p>
            </div>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Estadísticas del Local -->
    <ion-card class="stats-card mt-4 mx-2 shadow-lg border-0 bg-white">
      <ion-card-header class="pb-3">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center shadow-md">
              <ion-icon name="analytics-outline" class="text-white text-lg"></ion-icon>
            </div>
            <div>
              <ion-card-title class="text-xl font-bold text-gray-800">Estadísticas</ion-card-title>
              <p class="text-sm text-gray-500 mt-1">Resumen de facturas y finanzas</p>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <ion-button 
              fill="clear" 
              size="small" 
              (click)="recargarEstadisticas()"
              class="text-xs">
              <ion-icon name="refresh-outline" slot="icon-only"></ion-icon>
            </ion-button>
            <ion-spinner *ngIf="isLoadingStats()" name="lines-small" color="primary"></ion-spinner>
          </div>
        </div>
      </ion-card-header>
      
      <ion-card-content class="pt-0 px-4 pb-6">
        <!-- Estado de carga/error -->
        <div *ngIf="!estadisticas() && !isLoadingStats()" class="text-center py-8">
          <ion-icon name="analytics-outline" class="text-gray-400 text-4xl mb-2"></ion-icon>
          <p class="text-gray-500 text-sm">No hay estadísticas disponibles</p>
          <ion-button 
            fill="outline" 
            size="small" 
            (click)="recargarEstadisticas()" 
            class="mt-2">
            Recargar
          </ion-button>
        </div>

        <!-- Contenido de estadísticas -->
        <div *ngIf="estadisticas()">
          <!-- Estadísticas de Facturas -->
          <div class="mb-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-4 flex items-center gap-2">
              <ion-icon name="document-text-outline" class="text-blue-500"></ion-icon>
              Facturas
            </h3>
          <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
            <div 
              class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-xl border border-blue-200 cursor-pointer transition-all duration-200 hover:shadow-lg"
              [class.ring-2]="filtroEstadisticaActivo() === 'total'"
              [class.ring-blue-400]="filtroEstadisticaActivo() === 'total'"
              (click)="filtrarPorEstadistica('total')">
              <div class="flex items-center justify-between mb-2">
                <ion-icon name="document-text-outline" class="text-blue-600 text-xl"></ion-icon>
                <span class="text-2xl font-bold text-blue-700">{{ estadisticasFacturas().total || 0 }}</span>
              </div>
              <p class="text-sm font-medium text-blue-600">Total Facturas</p>
            </div>
            
            <div 
              class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-xl border border-green-200 cursor-pointer transition-all duration-200 hover:shadow-lg"
              [class.ring-2]="filtroEstadisticaActivo() === 'pagadas'"
              [class.ring-green-400]="filtroEstadisticaActivo() === 'pagadas'"
              (click)="filtrarPorEstadistica('pagadas')">
              <div class="flex items-center justify-between mb-2">
                <ion-icon name="checkmark-circle-outline" class="text-green-600 text-xl"></ion-icon>
                <span class="text-2xl font-bold text-green-700">{{ estadisticasFacturas().pagadas || 0 }}</span>
              </div>
              <p class="text-sm font-medium text-green-600">Pagadas</p>
            </div>
            
            <div 
              class="bg-gradient-to-br from-orange-50 to-orange-100 p-4 rounded-xl border border-orange-200 cursor-pointer transition-all duration-200 hover:shadow-lg"
              [class.ring-2]="filtroEstadisticaActivo() === 'pendientes'"
              [class.ring-orange-400]="filtroEstadisticaActivo() === 'pendientes'"
              (click)="filtrarPorEstadistica('pendientes')">
              <div class="flex items-center justify-between mb-2">
                <ion-icon name="time-outline" class="text-orange-600 text-xl"></ion-icon>
                <span class="text-2xl font-bold text-orange-700">{{ estadisticasFacturas().pendientes || 0 }}</span>
              </div>
              <p class="text-sm font-medium text-orange-600">Pendientes</p>
            </div>
            
            <div 
              class="bg-gradient-to-br from-red-50 to-red-100 p-4 rounded-xl border border-red-200 cursor-pointer transition-all duration-200 hover:shadow-lg"
              [class.ring-2]="filtroEstadisticaActivo() === 'vencidas'"
              [class.ring-red-400]="filtroEstadisticaActivo() === 'vencidas'"
              (click)="filtrarPorEstadistica('vencidas')">
              <div class="flex items-center justify-between mb-2">
                <ion-icon name="close-circle-outline" class="text-red-600 text-xl"></ion-icon>
                <span class="text-2xl font-bold text-red-700">{{ estadisticasFacturas().vencidas || 0 }}</span>
              </div>
              <p class="text-sm font-medium text-red-600">Vencidas</p>
            </div>
            
            <div 
              class="bg-gradient-to-br from-gray-50 to-gray-100 p-4 rounded-xl border border-gray-200 cursor-pointer transition-all duration-200 hover:shadow-lg"
              [class.ring-2]="filtroEstadisticaActivo() === 'anuladas'"
              [class.ring-gray-400]="filtroEstadisticaActivo() === 'anuladas'"
              (click)="filtrarPorEstadistica('anuladas')">
              <div class="flex items-center justify-between mb-2">
                <ion-icon name="ban-outline" class="text-gray-600 text-xl"></ion-icon>
                <span class="text-2xl font-bold text-gray-700">{{ estadisticasFacturas().anuladas || 0 }}</span>
              </div>
              <p class="text-sm font-medium text-gray-600">Anuladas</p>
            </div>
          </div>
        </div>

        <!-- Estadísticas Financieras -->
        <div *ngIf="estadisticas()?.estadisticas_financieras">
          <h3 class="text-lg font-semibold text-gray-700 mb-4 flex items-center gap-2">
            <ion-icon name="trending-up-outline" class="text-green-500"></ion-icon>
            Finanzas
          </h3>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Total Recaudado -->
            <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 p-4 rounded-xl border border-emerald-200">
              <div class="flex items-center justify-between mb-2">
                <ion-icon name="cash-outline" class="text-emerald-600 text-xl"></ion-icon>
                <span class="text-xl font-bold text-emerald-700">
                  L. {{ estadisticas()?.estadisticas_financieras?.total_recaudado || 0 | currency:'':'':'1.2-2' }}
                </span>
              </div>
              <p class="text-sm font-medium text-emerald-600">Total Recaudado</p>
            </div>

            <!-- Monto Pendiente -->
            <div class="bg-gradient-to-br from-amber-50 to-amber-100 p-4 rounded-xl border border-amber-200">
              <div class="flex items-center justify-between mb-2">
                <ion-icon name="wallet-outline" class="text-amber-600 text-xl"></ion-icon>
                <span class="text-xl font-bold text-amber-700">
                  L. {{ estadisticas()?.estadisticas_financieras?.monto_pendiente || 0 | currency:'':'':'1.2-2' }}
                </span>
              </div>
              <p class="text-sm font-medium text-amber-600">Monto Pendiente</p>
            </div>

            <!-- Porcentaje de Recaudación -->
            <div class="bg-gradient-to-br from-indigo-50 to-indigo-100 p-4 rounded-xl border border-indigo-200">
              <div class="flex items-center justify-between mb-2">
                <ion-icon name="pie-chart-outline" class="text-indigo-600 text-xl"></ion-icon>
                <span class="text-xl font-bold text-indigo-700">
                  {{ estadisticas()?.estadisticas_financieras?.porcentaje_recaudacion || 0 | number:'1.1-1' }}%
                </span>
              </div>
              <p class="text-sm font-medium text-indigo-600">% Recaudación</p>
            </div>

            <!-- Recaudo Esperado Mensual -->
            <div class="bg-gradient-to-br from-cyan-50 to-cyan-100 p-4 rounded-xl border border-cyan-200">
              <div class="flex items-center justify-between mb-2">
                <ion-icon name="calendar-outline" class="text-cyan-600 text-xl"></ion-icon>
                <span class="text-xl font-bold text-cyan-700">
                  L. {{ estadisticas()?.estadisticas_financieras?.recaudo_esperado_mensual || 0 | currency:'':'':'1.2-2' }}
                </span>
              </div>
              <p class="text-sm font-medium text-cyan-600">Esperado Mensual</p>
            </div>

            <!-- Recaudo Esperado Anual -->
            <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-xl border border-purple-200">
              <div class="flex items-center justify-between mb-2">
                <ion-icon name="bar-chart-outline" class="text-purple-600 text-xl"></ion-icon>
                <span class="text-xl font-bold text-purple-700">
                  L. {{ estadisticas()?.estadisticas_financieras?.recaudo_esperado_anual || 0 | currency:'':'':'1.2-2' }}
                </span>
              </div>
              <p class="text-sm font-medium text-purple-600">Esperado Anual</p>
            </div>

            <!-- Monto Total Facturas -->
            <div class="bg-gradient-to-br from-slate-50 to-slate-100 p-4 rounded-xl border border-slate-200">
              <div class="flex items-center justify-between mb-2">
                <ion-icon name="receipt-outline" class="text-slate-600 text-xl"></ion-icon>
                <span class="text-xl font-bold text-slate-700">
                  L. {{ estadisticas()?.estadisticas_financieras?.monto_total_facturas || 0 | currency:'':'':'1.2-2' }}
                </span>
              </div>
              <p class="text-sm font-medium text-slate-600">Total Facturado</p>
            </div>
          </div>
        </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Sección de Facturas -->
    <ion-card class="facturas-card mt-4 mx-2 shadow-lg border-0 bg-white">
      <ion-card-header class="pb-3">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-xl flex items-center justify-center shadow-md">
              <ion-icon name="receipt-outline" class="text-white text-lg"></ion-icon>
            </div>
            <div>
              <ion-card-title class="text-xl font-bold text-gray-800 leading-tight">Facturas</ion-card-title>
              <p class="text-sm text-gray-500 mt-1">Gestión de facturas del local</p>
            </div>
          </div>
          <ion-button 
            *ngIf="canCreateFactura()" 
            fill="solid" 
            size="default" 
            (click)="openInvoiceModal()"
            class="px-4 py-2 font-semibold"
            color="primary">
            <ion-icon name="add-outline" slot="start"></ion-icon>
            Nueva Factura
          </ion-button>
        </div>
      </ion-card-header>
      
      <ion-card-content class="px-4 pb-6">
        <!-- Filtros y Búsqueda -->
        <div class="filters-section mb-6">
          <!-- Barra de búsqueda -->
          <div class="mb-4">
            <ion-searchbar
              [value]="searchTerm()"
              (ionInput)="onSearchTermChange($event.detail.value!)"
              placeholder="Buscar facturas..."
              debounce="300"
              show-clear-button="focus"
              class="custom-searchbar">
            </ion-searchbar>
          </div>
          
          <!-- Filtros -->
          <div class="filters-row grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
            <ion-select
              [value]="filtroEstado()"
              (ionChange)="onEstadoChange($event)"
              placeholder="Estado"
              interface="popover"
              class="filter-select bg-gray-50 rounded-lg">
              <ion-select-option value="">Todos los estados</ion-select-option>
              <ion-select-option value="PENDIENTE">Pendiente</ion-select-option>
              <ion-select-option value="PAGADA">Pagada</ion-select-option>
              <ion-select-option value="VENCIDA">Vencida</ion-select-option>
              <ion-select-option value="ANULADA">Anulada</ion-select-option>
            </ion-select>
            
            <ion-select
              [value]="filtroMes()"
              (ionChange)="onMesChange($event)"
              placeholder="Mes"
              interface="popover"
              class="filter-select bg-gray-50 rounded-lg">
              <ion-select-option value="">Todos los meses</ion-select-option>
              <ion-select-option value="1">Enero</ion-select-option>
              <ion-select-option value="2">Febrero</ion-select-option>
              <ion-select-option value="3">Marzo</ion-select-option>
              <ion-select-option value="4">Abril</ion-select-option>
              <ion-select-option value="5">Mayo</ion-select-option>
              <ion-select-option value="6">Junio</ion-select-option>
              <ion-select-option value="7">Julio</ion-select-option>
              <ion-select-option value="8">Agosto</ion-select-option>
              <ion-select-option value="9">Septiembre</ion-select-option>
              <ion-select-option value="10">Octubre</ion-select-option>
              <ion-select-option value="11">Noviembre</ion-select-option>
              <ion-select-option value="12">Diciembre</ion-select-option>
            </ion-select>
            
            <ion-select
              [value]="filtroAnio()"
              (ionChange)="onAnioChange($event)"
              placeholder="Año"
              interface="popover"
              class="filter-select bg-gray-50 rounded-lg">
              <ion-select-option value="">Todos los años</ion-select-option>
              <ion-select-option *ngFor="let year of getAvailableYears()" [value]="year">{{ year }}</ion-select-option>
            </ion-select>
            
            <ion-button 
              fill="outline" 
              (click)="limpiarFiltros()"
              class="h-full rounded-lg border-gray-300">
              <ion-icon name="filter-outline" slot="start"></ion-icon>
              Limpiar
            </ion-button>
          </div>
        </div>

        <!-- Lista de Facturas -->
        <div class="facturas-list">
          <!-- Loading de facturas -->
          <div *ngIf="isLoadingFacturas()" class="facturas-loading flex flex-col items-center justify-center py-12">
            <ion-spinner name="lines-small" color="primary" class="mb-3"></ion-spinner>
            <p class="text-gray-500 text-sm">Cargando facturas...</p>
          </div>

          <!-- No hay facturas -->
          <div *ngIf="!isLoadingFacturas() && filteredFacturas().length === 0" class="no-facturas flex flex-col items-center justify-center py-16 text-center">
            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
              <ion-icon name="document-outline" class="text-gray-400 text-2xl"></ion-icon>
            </div>
            <h3 class="text-lg font-semibold text-gray-700 mb-2">No hay facturas</h3>
            <p class="text-gray-500 mb-6 max-w-sm">Este local aún no tiene facturas registradas. Crea la primera factura para comenzar.</p>
            <ion-button 
              *ngIf="canCreateFactura()" 
              fill="solid" 
              (click)="openInvoiceModal()"
              color="primary"
              class="px-6">
              <ion-icon name="add-outline" slot="start"></ion-icon>
              Crear Primera Factura
            </ion-button>
          </div>

          <!-- Lista de facturas modernizada con Grid Responsivo -->
          <div *ngIf="!isLoadingFacturas() && filteredFacturas().length > 0" class="facturas-grid-container">
            <!-- Grid responsivo: 4 columnas escritorio, 2 columnas móvil -->
            <div class="facturas-grid">
              <div *ngFor="let factura of filteredFacturas(); trackBy: trackByFacturaId" 
                   class="factura-item-modern">
                
                <div class="modern-invoice-card" (click)="verDetalleFactura(factura)">
                  <!-- Header con correlativo y estado -->
                  <div class="invoice-header">
                    <div class="header-content">
                      <div class="invoice-number">
                        <h3>{{ factura.correlativo }}</h3>
                        <p>{{ factura.concepto }}</p>
                      </div>
                      <ion-badge 
                        [color]="getEstadoFacturaColor(factura.estado)"
                        class="status-badge">
                        {{ factura.estado }}
                      </ion-badge>
                    </div>
                  </div>

                  <!-- Contenido principal -->
                  <div class="invoice-body">
                    <!-- Monto prominente -->
                    <div class="amount-section">
                      <div class="amount">
                        L. {{ factura.monto | currency:'':'':'1.2-2' }}
                      </div>
                      <div class="amount-label">Monto Total</div>
                    </div>

                    <!-- Información del propietario compacta -->
                    <div class="owner-info">
                      <div class="owner-icon">
                        <ion-icon name="person"></ion-icon>
                      </div>
                      <div class="owner-details">
                        <div class="owner-name">{{ factura.propietario_nombre || 'Sin propietario' }}</div>
                        <div class="local-number">Local #{{ factura.local_numero || 'N/A' }}</div>
                      </div>
                    </div>

                    <!-- Información de fechas compacta -->
                    <div class="date-info">
                      <div class="date-item">
                        <ion-icon name="calendar-outline"></ion-icon>
                        <div>
                          <div class="date-value">{{ formatMesFromEndpoint(factura.mes) }}</div>
                          <div class="date-label">Período</div>
                        </div>
                      </div>
                      <div class="date-item">
                        <ion-icon name="time-outline"></ion-icon>
                        <div>
                          <div class="date-value">{{ factura.createdAt | date:'dd/MM' }}</div>
                          <div class="date-label">Creada</div>
                        </div>
                      </div>
                    </div>

                    <!-- Estado de pago/vencimiento -->
                    <div class="payment-status" *ngIf="factura.fecha_vencimiento || factura.fecha_pago">
                      <div *ngIf="factura.fecha_pago && factura.estado === 'PAGADA'" 
                           class="paid-status">
                        <ion-icon name="checkmark-circle"></ion-icon>
                        <span>Pagado: {{ factura.fecha_pago | date:'dd/MM/yyyy' }}</span>
                      </div>
                      <div *ngIf="!factura.fecha_pago && factura.fecha_vencimiento" 
                           class="due-status">
                        <ion-icon name="alert-circle"></ion-icon>
                        <span>Vence: {{ factura.fecha_vencimiento | date:'dd/MM' }}</span>
                      </div>
                    </div>

                    <!-- Botones de acción compactos -->
                    <div class="action-buttons-compact">
                      <!-- Botón Ver Detalles -->
                      <ion-button 
                        fill="clear" 
                        size="small" 
                        color="primary"
                        (click)="$event.stopPropagation(); verDetalleFactura(factura)"
                        class="action-btn"
                        title="Ver detalles de la factura">
                        <ion-icon name="eye-outline" slot="icon-only"></ion-icon>
                      </ion-button>

                      <!-- Botón Marcar como Pagada -->
                      <ion-button 
                        *ngIf="factura.estado === 'PENDIENTE' && canEditFactura()"
                        fill="clear" 
                        size="small" 
                        color="success"
                        (click)="$event.stopPropagation(); marcarComoPagada(factura)"
                        class="action-btn"
                        title="Marcar como pagada">
                        <ion-icon name="checkmark-circle-outline" slot="icon-only"></ion-icon>
                      </ion-button>

                      <!-- Botón Imprimir -->
                      <ion-button 
                        *ngIf="factura.estado !== 'ANULADA'"
                        fill="clear" 
                        size="small" 
                        color="secondary"
                        (click)="$event.stopPropagation(); reimprimirFactura(factura)"
                        class="action-btn"
                        title="Reimprimir factura">
                        <ion-icon name="print-outline" slot="icon-only"></ion-icon>
                      </ion-button>

                      <!-- Botón Editar -->
                      <ion-button 
                        *ngIf="factura.estado !== 'ANULADA' && canEditFactura()"
                        fill="clear" 
                        size="small" 
                        color="warning"
                        (click)="$event.stopPropagation(); editarFactura(factura)"
                        class="action-btn"
                        title="Editar factura">
                        <ion-icon name="create-outline" slot="icon-only"></ion-icon>
                      </ion-button>

                      <!-- Botón Anular -->
                      <ion-button 
                        *ngIf="factura.estado !== 'ANULADA' && canAnularFactura()"
                        fill="clear" 
                        size="small" 
                        color="danger"
                        (click)="$event.stopPropagation(); anularFactura(factura)"
                        class="action-btn"
                        title="Anular factura">
                        <ion-icon name="close-circle-outline" slot="icon-only"></ion-icon>
                      </ion-button>

                      <!-- Botón Eliminar (Solo ADMIN) -->
                      <ion-button 
                        *ngIf="factura.estado !== 'ANULADA' && canDeleteFactura()"
                        fill="clear" 
                        size="small" 
                        color="danger"
                        (click)="$event.stopPropagation(); eliminarFactura(factura)"
                        class="action-btn delete-btn"
                        title="Eliminar factura permanentemente">
                        <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
                      </ion-button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Infinite Scroll - Solo cuando no hay filtros activos -->
        <ion-infinite-scroll 
          *ngIf="hasMoreFacturas() && !hasActiveFilters()" 
          (ionInfinite)="cargarMasFacturas($event)"
          threshold="100px">
          <ion-infinite-scroll-content
            loading-spinner="bubbles"
            loading-text="Cargando más facturas...">
          </ion-infinite-scroll-content>
        </ion-infinite-scroll>
      </ion-card-content>
    </ion-card>
  </div>
  <!-- FAB para acciones rápidas -->
  <ion-fab vertical="bottom" horizontal="end" slot="fixed" *ngIf="canCreateFactura()">
    <ion-fab-button color="primary" (click)="openInvoiceModal()">
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
  </ion-fab>

  <!-- Compact Invoice Creation Modal -->
  <ion-modal [isOpen]="showInvoiceModal()" (didDismiss)="closeInvoiceModal()" class="invoice-modal">
    <ng-template>
      <div class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center p-3 z-50">
        <div class="bg-white rounded-2xl shadow-lg w-full max-w-md mx-auto overflow-hidden">
          <!-- Encabezado con logo, nombre del mercado y monto mensual -->
          <div class="relative bg-gradient-to-r from-cyan-500 to-blue-400 p-6 pb-4 flex flex-col items-center">
            <img src="assets/logos/logo4.png" alt="Logo" class="w-16 h-16 rounded-full bg-white shadow mb-2" style="object-fit:contain;" />
            <div class="text-center text-white">
              <div class="text-lg font-bold mb-1">{{ mercadoNombre || 'Mercado' }}</div>
              <div class="text-xs font-semibold tracking-wide">Monto Mensual</div>
              <div class="text-2xl font-bold tracking-tight">LPS. {{ local()?.monto_mensual || '---' }}</div>
            </div>
            <button (click)="closeInvoiceModal()" 
              class="absolute top-3 right-3 w-8 h-8 flex items-center justify-center transition-all duration-200 z-10"
              style="background: transparent; border: none; box-shadow: none;"
              (mouseenter)="isCloseHovered = true" (mouseleave)="isCloseHovered = false">
              <span class="text-2xl font-bold leading-none transition-colors duration-200"
                [ngStyle]="{'color': isCloseHovered ? '#ef4444' : '#fff'}">×</span>
            </button>
          </div>
          <div class="p-5 pt-3 space-y-4">
            <!-- Selección de mes -->
            <div>
              <label class="block text-cyan-700 font-semibold mb-1 text-sm flex items-center">
                <ion-icon name="calendar-outline" class="mr-1 text-cyan-500"></ion-icon>
                Mes a Facturar
              </label>
              <ion-select [(ngModel)]="selectedMonth" placeholder="Seleccionar mes" interface="popover" class="w-full rounded-lg border border-cyan-200 bg-gray-50">
                <ion-select-option value="1">Enero</ion-select-option>
                <ion-select-option value="2">Febrero</ion-select-option>
                <ion-select-option value="3">Marzo</ion-select-option>
                <ion-select-option value="4">Abril</ion-select-option>
                <ion-select-option value="5">Mayo</ion-select-option>
                <ion-select-option value="6">Junio</ion-select-option>
                <ion-select-option value="7">Julio</ion-select-option>
                <ion-select-option value="8">Agosto</ion-select-option>
                <ion-select-option value="9">Septiembre</ion-select-option>
                <ion-select-option value="10">Octubre</ion-select-option>
                <ion-select-option value="11">Noviembre</ion-select-option>
                <ion-select-option value="12">Diciembre</ion-select-option>
              </ion-select>
            </div>
            <!-- Resumen de Factura -->
            <div *ngIf="selectedMonth() > 0" class="bg-gray-50 rounded-xl p-4 border border-gray-200">
              <div class="flex items-center mb-2">
                <ion-icon name="document-outline" class="mr-2 text-cyan-600 text-lg"></ion-icon>
                <span class="text-lg font-bold text-cyan-800">Resumen de Factura</span>
              </div>
              <div class="grid grid-cols-2 gap-x-2 gap-y-1 text-sm">
                <div class="font-medium text-gray-600">Mes:</div>
                <div class="text-gray-900">{{ getMonthName(selectedMonth()) }}</div>
                <div class="font-medium text-gray-600">Concepto:</div>
                <div class="text-gray-900">Cuota {{ getMonthName(selectedMonth()) }} {{ getCurrentYear() }}</div>
                <div class="font-medium text-gray-600">Vence:</div>
                <div class="text-gray-900">{{ getNextDueDate(selectedMonth()) }}</div>
                <div class="font-medium text-gray-600 col-span-2">Observaciones:</div>
                <div class="col-span-2 text-gray-900">Factura generada automáticamente</div>
              </div>
            </div>
            <!-- Botones -->
            <div class="flex gap-3 pt-2">
              <button type="button"
                (click)="closeInvoiceModal()"
                style="border-radius: 1rem; padding: 5px;"
                class="flex-1 py-3 bg-gray-500 hover:bg-gray-600 text-white font-bold text-base flex items-center justify-center gap-2 shadow">
                <ion-icon name="close-outline" class="text-lg"></ion-icon>
                Cancelar
              </button>
              <button type="button"
                [disabled]="!selectedMonth() || selectedMonth() === 0 || isCreatingInvoice()"
                (click)="createInvoice()"
                style="background: #5ccedf; border-radius: 1rem; padding: 5px;"
                class="flex-1 text-white font-bold text-base flex items-center justify-center gap-2 shadow disabled:opacity-60 border-0">
                <ng-container *ngIf="isCreatingInvoice(); else crearText">
                  <ion-spinner name="circular" class="w-5 h-5 text-white"></ion-spinner>
                  <span>Creando...</span>
                </ng-container>
                <ng-template #crearText>
                  <ion-icon name="add-circle-outline" class="text-lg"></ion-icon>
                  Crear
                </ng-template>
              </button>
            </div>
          </div>
        </div>
      </div>
    </ng-template>
  </ion-modal>

  <!-- Modal Detalle Factura Moderno Responsive -->
  <ion-modal 
    [isOpen]="showFacturaDetailModal()" 
    (didDismiss)="cerrarFacturaDetailModal()" 
    class="factura-detail-modal-responsive"
    [breakpoints]="[0.25, 0.5, 0.75, 1]"
    [initialBreakpoint]="0.75">
    <ng-template>
      <div class="modal-container">
        
        <!-- Header con diseño mejorado -->
        <div class="modal-header">
          
          <!-- Botón cerrar mejorado -->
          <button 
            (click)="cerrarFacturaDetailModal()" 
            class="close-button"
            [class.close-hovered]="isCloseHovered"
            (mouseenter)="isCloseHovered = true"
            (mouseleave)="isCloseHovered = false"
            aria-label="Cerrar modal">
            <ion-icon name="close" class="close-icon"></ion-icon>
          </button>

          <!-- Información principal del header -->
          <div class="header-content">
            <div class="invoice-icon">
              <ion-icon name="receipt-outline" class="icon"></ion-icon>
            </div>
            
            <div class="invoice-info">
              <h2 class="invoice-number">{{ facturaSeleccionada()?.correlativo || facturaSeleccionada()?.numero_factura }}</h2>
              <p class="invoice-concept">{{ facturaSeleccionada()?.concepto }}</p>
            </div>
            
            <!-- Monto total destacado con mejor visibilidad -->
            <div class="amount-display">
              <div class="amount-value">L. {{ (facturaSeleccionada()?.monto || 0) | number:'1.2-2' }}</div>
              <div class="amount-label">Monto Total</div>
            </div>
          </div>
        </div>

        <!-- Contenido principal con scroll -->
        <div class="modal-content" *ngIf="facturaSeleccionada()">
          
          <!-- Estado de la factura con mejor visibilidad -->
          <div class="status-section">
            <ion-badge 
              [color]="getEstadoFacturaColor(facturaSeleccionada()?.estado || 'medium')"
              class="status-badge">
              {{ facturaSeleccionada()?.estado }}
            </ion-badge>
          </div>

          <!-- Información detallada con mejor estructura -->
          <div class="details-grid">
            
            <!-- Información del Local -->
            <div class="detail-card local-info-card">
              <div class="card-header">
                <div class="card-icon local-icon">
                  <ion-icon name="storefront-outline"></ion-icon>
                </div>
                <div class="card-title">
                  <h4>Información del Local</h4>
                  <p>Datos del establecimiento</p>
                </div>
              </div>
              <div class="card-content">
                <div class="info-row">
                  <span class="info-label">Local:</span>
                  <span class="info-value">#{{ facturaSeleccionada()?.local_numero || 'N/A' }}</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Propietario:</span>
                  <span class="info-value">{{ facturaSeleccionada()?.propietario_nombre || 'Sin propietario' }}</span>
                </div>
                <div class="info-row" *ngIf="facturaSeleccionada()?.propietario_dni">
                  <span class="info-label">DNI:</span>
                  <span class="info-value">{{ facturaSeleccionada()?.propietario_dni }}</span>
                </div>
              </div>
            </div>
            
            <!-- Período de facturación -->
            <div class="detail-card period-card">
              <div class="card-header">
                <div class="card-icon period-icon">
                  <ion-icon name="calendar-outline"></ion-icon>
                </div>
                <div class="card-title">
                  <h4>Período de Facturación</h4>
                  <p>Mes y año que se está cobrando</p>
                </div>
              </div>
              <div class="card-content">
                <div class="period-display">
                  {{ formatMesFromEndpoint(facturaSeleccionada()?.mes || '') }}
                </div>
                <div class="period-year" *ngIf="facturaSeleccionada()?.anio">
                  Año: {{ facturaSeleccionada()?.anio }}
                </div>
              </div>
            </div>

            <!-- Fechas importantes -->
            <div class="detail-card dates-card">
              <div class="card-header">
                <div class="card-icon dates-icon">
                  <ion-icon name="time-outline"></ion-icon>
                </div>
                <div class="card-title">
                  <h4>Fechas Importantes</h4>
                  <p>Registro y vencimientos</p>
                </div>
              </div>
              <div class="card-content">
                <div class="date-row">
                  <span class="date-label">
                    <ion-icon name="document-outline"></ion-icon>
                    Fecha de Creación:
                  </span>
                  <span class="date-value">{{ facturaSeleccionada()?.createdAt | date:'dd/MM/yyyy HH:mm' }}</span>
                </div>
                <div class="date-row">
                  <span class="date-label">
                    <ion-icon name="alert-circle-outline"></ion-icon>
                    Fecha de Vencimiento:
                  </span>
                  <span class="date-value">{{ facturaSeleccionada()?.fecha_vencimiento | date:'dd/MM/yyyy' }}</span>
                </div>
                <div class="date-row" *ngIf="facturaSeleccionada()?.fecha_pago">
                  <span class="date-label">
                    <ion-icon name="checkmark-circle-outline"></ion-icon>
                    Fecha de Pago:
                  </span>
                  <span class="date-value paid">{{ facturaSeleccionada()?.fecha_pago | date:'dd/MM/yyyy HH:mm' }}</span>
                </div>
              </div>
            </div>

            <!-- Información Financiera -->
            <div class="detail-card financial-card">
              <div class="card-header">
                <div class="card-icon financial-icon">
                  <ion-icon name="cash-outline"></ion-icon>
                </div>
                <div class="card-title">
                  <h4>Información Financiera</h4>
                  <p>Detalles del monto</p>
                </div>
              </div>
              <div class="card-content">
                <div class="financial-row main-amount">
                  <span class="financial-label">Monto Total:</span>
                  <span class="financial-value primary">L. {{ (facturaSeleccionada()?.monto || 0) | number:'1.2-2' }}</span>
                </div>
                <div class="financial-row" *ngIf="facturaSeleccionada()?.estado === 'PAGADA'">
                  <span class="financial-label">Estado:</span>
                  <span class="financial-value success">Pagada completamente</span>
                </div>
                <div class="financial-row" *ngIf="facturaSeleccionada()?.estado === 'PENDIENTE'">
                  <span class="financial-label">Estado:</span>
                  <span class="financial-value warning">Pago pendiente</span>
                </div>
                <div class="financial-row" *ngIf="facturaSeleccionada()?.estado === 'VENCIDA'">
                  <span class="financial-label">Estado:</span>
                  <span class="financial-value danger">Factura vencida</span>
                </div>
              </div>
            </div>

            <!-- Observaciones si existen -->
            <div class="detail-card observations-card" *ngIf="facturaSeleccionada()?.observaciones">
              <div class="card-header">
                <div class="card-icon observations-icon">
                  <ion-icon name="chatbubble-outline"></ion-icon>
                </div>
                <div class="card-title">
                  <h4>Observaciones</h4>
                  <p>Notas adicionales</p>
                </div>
              </div>
              <div class="card-content">
                <div class="observations-text">{{ facturaSeleccionada()?.observaciones }}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Botones de acción fijos en la parte inferior -->
        <div class="actions-section">
          
          <!-- Botón principal según estado -->
          <div class="primary-action" *ngIf="facturaSeleccionada()?.estado === 'PENDIENTE' && canEditFactura()">
            <ion-button 
              expand="block" 
              color="success" 
              size="large"
              (click)="marcarComoPagada(facturaSeleccionada()!)"
              class="primary-button"
              title="Cambiar estado de la factura a PAGADA">
              <ion-icon name="checkmark-circle-outline" slot="start"></ion-icon>
              Marcar como Pagada
            </ion-button>
          </div>

          <!-- Botones secundarios en línea -->
          <div class="secondary-actions" 
               [class.has-many-actions]="(facturaSeleccionada()?.estado !== 'ANULADA' && canEditFactura() && canAnularFactura())">
            
            <ion-button 
              fill="outline" 
              color="primary" 
              size="default"
              (click)="reimprimirFactura(facturaSeleccionada()!)"
              class="action-button"
              title="Reimprimir factura">
              <ion-icon name="print-outline" slot="start"></ion-icon>
              <span class="button-text">Reimprimir</span>
            </ion-button>
            
            <ion-button 
              fill="outline" 
              color="warning" 
              size="default"
              *ngIf="facturaSeleccionada()?.estado !== 'ANULADA' && canEditFactura()"
              (click)="editarFactura(facturaSeleccionada()!)"
              class="action-button"
              title="Editar información de la factura">
              <ion-icon name="create-outline" slot="start"></ion-icon>
              <span class="button-text">Editar</span>
            </ion-button>

            <ion-button 
              fill="outline" 
              color="danger" 
              size="default"
              *ngIf="facturaSeleccionada()?.estado !== 'ANULADA' && canAnularFactura()"
              (click)="anularFactura(facturaSeleccionada()!)"
              class="action-button danger-button"
              title="Anular factura (cambiar estado a ANULADA)">
              <ion-icon name="trash-outline" slot="start"></ion-icon>
              <span class="button-text">Anular</span>
            </ion-button>
          </div>
        </div>
      </div>
    </ng-template>
  </ion-modal>
</ion-content>
