<ion-header [translucent]="true" class="ion-no-border safe-area-header">
  <div class="safe-area-spacer"></div>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button
        defaultHref="/dashboard/user"
        color="light"
      ></ion-back-button>
    </ion-buttons>
    <ion-title color="light" class="font-semibold">Estado de Cuenta</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="bg-gray-50 safe-area-content">
  <!-- Main container with proper spacing -->
  <div class="px-4 py-6 min-h-full">
    <!-- Modern Search Card -->
    <div
      class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6 mb-6 mx-auto max-w-2xl"
    >
      <!-- Search Header -->
      <div class="flex items-center gap-3 mb-4">
        <div
          class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center"
        >
          <ion-icon
            name="search-outline"
            class="text-xl text-blue-600"
          ></ion-icon>
        </div>
        <div>
          <h2 class="text-lg font-bold text-gray-800">
            Buscar Estado de Cuenta
          </h2>
          <p class="text-sm text-gray-500">
            Consulte por Clave Catastral o DNI
          </p>
        </div>
      </div>

      <!-- Search Input Component -->
      <app-search-input
        (search)="onSearch($event)"
        (clear)="onClearSearch()"
        [disabled]="isLoading()"
        placeholder="Buscar estado de cuenta..."
        class="block w-full"
      >
      </app-search-input>

      <!-- Search Summary -->
      <div *ngIf="lastSearchParams" class="mt-4">
        <ion-chip color="primary" outline="true" class="text-sm">
          <ion-icon name="search-outline"></ion-icon>
          <ion-label>{{ getSearchSummary() }}</ion-label>
        </ion-chip>
      </div>
    </div>

    <!-- Error Card -->
    <div
      *ngIf="searchError()"
      class="bg-red-50 border border-red-200 rounded-xl p-4 mb-6"
    >
      <div class="flex items-start gap-3">
        <div
          class="w-6 h-6 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5"
        >
          <ion-icon name="alert-circle" class="text-red-600 text-sm"></ion-icon>
        </div>
        <div>
          <h3 class="font-semibold text-red-800 mb-1">Error en la consulta</h3>
          <p class="text-red-700 text-sm">{{ searchError() }}</p>
        </div>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="isLoading()" class="text-center py-12">
      <ion-spinner name="crescent" color="primary" class="mb-4"></ion-spinner>
      <p class="text-gray-600">Consultando estado de cuenta...</p>
    </div>

    <!-- Results Section -->
    <div *ngIf="!isLoading() && estadoCuenta() as data" class="space-y-6">
      <!-- Multiple Properties (DNI Search) -->
      <div
        *ngIf="esDNI && tienePropiedades"
        class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6"
      >
        <!-- Properties Header -->
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-3">
            <div
              class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center"
            >
              <ion-icon
                name="home-outline"
                class="text-xl text-green-600"
              ></ion-icon>
            </div>
            <div>
              <h3 class="text-lg font-bold text-gray-800">
                Propiedades Encontradas
              </h3>
              <p class="text-sm text-gray-500">
                {{ numeroPropiedades }} propiedades registradas
              </p>
            </div>
          </div>
          <div class="bg-blue-50 px-3 py-1 rounded-full">
            <span class="text-sm font-semibold text-blue-700"
              >Total: {{ totalGeneralGrupal }}</span
            >
          </div>
        </div>

        <!-- Properties List -->
        <div class="space-y-2">
          <div
            *ngFor="let propiedad of propiedades; let i = index"
            (click)="seleccionarPropiedad(propiedad, i)"
            [class]="indicePropiedadSeleccionada() === i ? 
              'bg-blue-50 border-blue-200 shadow-md' : 
              'bg-gray-50 border-gray-200 hover:bg-gray-100'"
            class="border rounded-xl p-4 cursor-pointer transition-all duration-200"
          >
            <div class="flex items-center gap-3">
              <div
                [class]="indicePropiedadSeleccionada() === i ? 
                'w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center' :
                'w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center'"
              >
                <ion-icon
                  name="home"
                  [class]="indicePropiedadSeleccionada() === i ? 'text-blue-600' : 'text-gray-500'"
                  class="text-sm"
                >
                </ion-icon>
              </div>

              <div class="flex-1">
                <h4 class="font-semibold text-gray-800">
                  {{ propiedad.claveCatastral }}
                </h4>
                <p class="text-sm text-gray-600">
                  {{ propiedad.nombreColonia }}
                </p>
                <p class="text-sm font-medium text-blue-600 mt-1">
                  Total: {{ formatCurrency(propiedad.totalPropiedadNumerico) }}
                </p>
              </div>

              <div
                *ngIf="indicePropiedadSeleccionada() === i"
                class="w-6 h-6 bg-blue-600 rounded-full flex items-center justify-center"
              >
                <ion-icon
                  name="checkmark"
                  class="text-white text-sm"
                ></ion-icon>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Info and Details Card -->
      <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6">
        <!-- User Profile Section -->
        <div class="flex items-center gap-4 mb-6">
          <div
            class="w-14 h-14 bg-gradient-to-br from-blue-400 to-blue-600 rounded-full flex items-center justify-center"
          >
            <ion-icon
              name="person-circle-outline"
              class="text-3xl text-white"
            ></ion-icon>
          </div>

          <div class="flex-1 min-w-0">
            <h2 class="text-xl font-bold text-gray-900 truncate">
              {{ data.nombre }}
            </h2>
            <p class="text-blue-600 font-semibold">{{ data.identidad }}</p>

            <div class="mt-3 space-y-1 text-sm">
              <div class="flex flex-wrap gap-4">
                <div class="flex items-center gap-1">
                  <span class="font-medium text-gray-600">Clave:</span>
                  <span class="text-blue-600 font-semibold"
                    >{{ data.claveCatastral }}</span
                  >
                </div>
                <div class="flex items-center gap-1">
                  <span class="font-medium text-gray-600">Colonia:</span>
                  <span class="text-blue-600 font-semibold"
                    >{{ data.nombreColonia }}</span
                  >
                </div>
              </div>
              <div class="flex items-center gap-1">
                <span class="font-medium text-gray-600">Consultado:</span>
                <span class="text-gray-700"
                  >{{ data.fecha }} - {{ data.hora }}</span
                >
              </div>
            </div>
          </div>
        </div>

        <!-- Detail Section Header -->
        <div
          class="flex items-center justify-between mb-4 pb-4 border-b border-gray-200"
        >
          <div class="flex items-center gap-3">
            <div
              class="w-8 h-8 bg-orange-100 rounded-full flex items-center justify-center"
            >
              <ion-icon
                name="receipt-outline"
                class="text-orange-600"
              ></ion-icon>
            </div>
            <h3 class="text-lg font-bold text-gray-800">Detalle de Mora</h3>
          </div>

          <!-- Action Buttons -->
          <div class="flex gap-2">
            <ion-button
              fill="outline"
              size="small"
              (click)="esDNI ? mostrarOpcionesImpresion() : imprimirRecibo()"
              [disabled]="isLoading()"
              class="no-print h-8 text-xs"
            >
              <ion-icon
                name="print-outline"
                slot="start"
                class="text-sm"
              ></ion-icon>
              {{ esDNI ? 'Opciones' : 'Ticket' }}
            </ion-button>
          </div>
        </div>

        <!-- Table Container for printing -->
        <div class="printable">
          <!-- Print Header (hidden on screen) -->
          <div class="print-header" style="display: none">
            <div class="print-title">
              ALCALDÍA MUNICIPAL DEL DISTRITO CENTRAL
            </div>
            <div class="print-subtitle">Estado de Cuenta</div>
            <div class="print-info">Fecha: {{ getCurrentDate() }}</div>
          </div>

          <!-- Contributor Info for printing (hidden on screen) -->
          <div class="contributor-info" style="display: none">
            <div class="info-row">
              <span class="label">Nombre:</span>
              <span class="value">{{ data.nombre }}</span>
            </div>
            <div class="info-row">
              <span class="label">Identidad:</span>
              <span class="value">{{ data.identidad }}</span>
            </div>
            <div class="info-row">
              <span class="label">Clave Catastral:</span>
              <span class="value">{{ data.claveCatastral }}</span>
            </div>
            <div class="info-row">
              <span class="label">Colonia:</span>
              <span class="value">{{ data.nombreColonia }}</span>
            </div>
          </div>

          <!-- Modern Details Table -->
          <div class="modern-table-container">
            <!-- Table Header Stats -->
            <div class="table-stats-header">
              <div class="stat-card">
                <div class="stat-icon">
                  <ion-icon name="calendar-outline"></ion-icon>
                </div>
                <div class="stat-info">
                  <span class="stat-value">{{ data.detallesMora.length }}</span>
                  <span class="stat-label">Años</span>
                </div>
              </div>

              <div class="stat-card">
                <div class="stat-icon total-icon">
                  <ion-icon name="wallet-outline"></ion-icon>
                </div>
                <div class="stat-info">
                  <span class="stat-value total-value"
                    >{{ formatCurrency(data.totalGeneralNumerico) }}</span
                  >
                  <span class="stat-label">Total a pagar</span>
                </div>
              </div>
            </div>

            <!-- Enhanced Table -->
            <div class="table-wrapper">
              <!-- Desktop/Tablet Table View -->
              <table class="modern-detail-table desktop-table">
                <thead>
                  <tr>
                    <th class="year-header">
                      <div class="header-content">
                        <ion-icon name="calendar-outline"></ion-icon>
                        <span>Año</span>
                      </div>
                    </th>
                    <th class="amount-header">
                      <div class="header-content">
                        <ion-icon name="home-outline"></ion-icon>
                        <span>Impuesto</span>
                      </div>
                    </th>
                    <th class="amount-header">
                      <div class="header-content">
                        <ion-icon name="trash-outline"></ion-icon>
                        <span>T. Aseo</span>
                      </div>
                    </th>
                    <th class="amount-header">
                      <div class="header-content">
                        <ion-icon name="flame-outline"></ion-icon>
                        <span>Bomberos</span>
                      </div>
                    </th>
                    <th class="amount-header">
                      <div class="header-content">
                        <ion-icon name="trending-up-outline"></ion-icon>
                        <span>Recargo</span>
                      </div>
                    </th>
                    <th class="total-header">
                      <div class="header-content">
                        <ion-icon name="calculator-outline"></ion-icon>
                        <span>Total</span>
                      </div>
                    </th>
                  </tr>
                </thead>
                <tbody>
                  <tr
                    *ngFor="let detalle of data.detallesMora; let i = index"
                    class="table-row"
                    [class.even-row]="i % 2 === 0"
                    [class.odd-row]="i % 2 === 1"
                  >
                    <td class="year-cell">
                      <div class="year-badge">
                        <span class="year-number">{{ detalle.year }}</span>
                      </div>
                    </td>

                    <td class="amount-cell">
                      <div class="amount-container">
                        <span class="currency-symbol">L.</span>
                        <span class="amount-value"
                          >{{ formatNumber(detalle.impuestoNumerico) }}</span
                        >
                      </div>
                    </td>

                    <td class="amount-cell">
                      <div class="amount-container">
                        <span class="currency-symbol">L.</span>
                        <span class="amount-value"
                          >{{ formatNumber(detalle.trenDeAseoNumerico) }}</span
                        >
                      </div>
                    </td>

                    <td class="amount-cell">
                      <div class="amount-container">
                        <span class="currency-symbol">L.</span>
                        <span class="amount-value"
                          >{{ formatNumber(detalle.tasaBomberosNumerico)
                          }}</span
                        >
                      </div>
                    </td>

                    <td class="amount-cell recargo-cell">
                      <div class="amount-container">
                        <span class="currency-symbol">L.</span>
                        <span class="amount-value"
                          >{{ formatNumber(detalle.recargoNumerico) }}</span
                        >
                      </div>
                    </td>

                    <td class="total-cell">
                      <div class="total-container">
                        <span class="currency-symbol">L.</span>
                        <span class="total-value"
                          >{{ formatNumber(detalle.totalNumerico) }}</span
                        >
                      </div>
                    </td>
                  </tr>
                </tbody>
                <tfoot>
                  <tr class="grand-total-row">
                    <td colspan="5" class="grand-total-label">
                      <div class="total-label-container">
                        <ion-icon name="receipt-outline"></ion-icon>
                        <span>TOTAL GENERAL</span>
                      </div>
                    </td>
                    <td class="grand-total-cell">
                      <div class="grand-total-container">
                        <span class="currency-symbol">L.</span>
                        <span class="grand-total-value"
                          >{{ formatNumber(data.totalGeneralNumerico) }}</span
                        >
                      </div>
                    </td>
                  </tr>
                </tfoot>
              </table>

              <!-- Mobile Card View -->
              <div class="mobile-cards-view">
                <div
                  *ngFor="let detalle of data.detallesMora; let i = index"
                  class="detail-card-mobile"
                >
                  <!-- Card Header -->
                  <div class="card-header-mobile">
                    <div class="year-badge-mobile">
                      <ion-icon name="calendar-outline"></ion-icon>
                      <span>{{ detalle.year }}</span>
                    </div>
                    <div class="total-badge-mobile">
                      <span class="currency">L.</span>
                      <span class="amount"
                        >{{ formatNumber(detalle.totalNumerico) }}</span
                      >
                    </div>
                  </div>

                  <!-- Card Content -->
                  <div class="card-content-mobile">
                    <div class="amount-row">
                      <div class="amount-item">
                        <ion-icon name="home-outline"></ion-icon>
                        <span class="label">Impuesto</span>
                        <span class="value"
                          >L. {{ formatNumber(detalle.impuestoNumerico) }}</span
                        >
                      </div>
                      <div class="amount-item">
                        <ion-icon name="trash-outline"></ion-icon>
                        <span class="label">T. Aseo</span>
                        <span class="value"
                          >L. {{ formatNumber(detalle.trenDeAseoNumerico)
                          }}</span
                        >
                      </div>
                    </div>

                    <div class="amount-row">
                      <div class="amount-item">
                        <ion-icon name="flame-outline"></ion-icon>
                        <span class="label">Bomberos</span>
                        <span class="value"
                          >L. {{ formatNumber(detalle.tasaBomberosNumerico)
                          }}</span
                        >
                      </div>
                      <div class="amount-item recargo">
                        <ion-icon name="trending-up-outline"></ion-icon>
                        <span class="label">Recargo</span>
                        <span class="value"
                          >L. {{ formatNumber(detalle.recargoNumerico) }}</span
                        >
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Mobile Total Card -->
                <div class="total-card-mobile">
                  <div class="total-header-mobile">
                    <ion-icon name="receipt-outline"></ion-icon>
                    <span>TOTAL GENERAL</span>
                  </div>
                  <div class="total-amount-mobile">
                    <span class="currency">L.</span>
                    <span class="amount"
                      >{{ formatNumber(data.totalGeneralNumerico) }}</span
                    >
                  </div>
                </div>
              </div>
            </div>

            <!-- Table Footer Info -->
            <div class="table-footer-info">
              <div class="info-item">
                <ion-icon name="information-circle-outline"></ion-icon>
                <span
                  >Los montos incluyen recargos por mora según normativa
                  municipal</span
                >
              </div>
              <div class="info-item">
                <ion-icon name="time-outline"></ion-icon>
                <span
                  >Consulta realizada: {{ data.fecha }} {{ data.hora }}</span
                >
              </div>
            </div>
          </div>

          <!-- Print Footer (hidden on screen) -->
          <div class="print-footer" style="display: none">
            <p>Este documento es válido únicamente para fines informativos.</p>
            <p>Para pagos oficiales, diríjase a las oficinas municipales.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div
      *ngIf="!isLoading() && !estadoCuenta() && !searchError()"
      class="text-center py-16"
    >
      <div
        class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4"
      >
        <ion-icon
          name="search-outline"
          class="text-3xl text-gray-400"
        ></ion-icon>
      </div>
      <h3 class="text-lg font-semibold text-gray-700 mb-2">
        Consultar Estado de Cuenta
      </h3>
      <p class="text-gray-500 max-w-md mx-auto">
        Utilice el formulario de búsqueda para consultar el estado de cuenta por
        Clave Catastral o DNI.
      </p>
    </div>
  </div>
</ion-content>
