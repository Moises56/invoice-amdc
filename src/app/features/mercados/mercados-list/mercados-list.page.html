<ion-header style="background:#5ccedf;">  <ion-toolbar class="header-toolbar" style="background:#5ccedf; min-height: env(safe-area-inset-top, 24px) + 56px; padding-top: env(safe-area-inset-top, 24px);">
    <ion-buttons slot="start">
      <ion-menu-button class="text-white menu-button"></ion-menu-button>
    </ion-buttons>
    <ion-title class="text-white font-semibold header-title" style="color:#fff; font-weight:bold;">Gesti3n de Mercados</ion-title>
    <ion-buttons slot="end">
      <ion-button fill="clear" (click)="showFilters.set(!showFilters())" class="action-button">
        <ion-icon name="filter-outline" slot="icon-only" class="text-white"></ion-icon>
      </ion-button>
      <ion-button fill="clear" (click)="exportMercados()" class="action-button">
        <ion-icon name="download-outline" slot="icon-only" class="text-white"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <!-- Filters Section -->  <ion-toolbar *ngIf="showFilters()" class="filters-toolbar">
    <div class="filters-container">
      <ion-grid class="filter-grid">
        <ion-row>
          <ion-col size="12" size-md="4">
            <ion-select
              placeholder="Estado"
              interface="popover"
              class="filter-select"
              [(ngModel)]="selectedEstado"
              (ionChange)="selectedEstado.set($event.detail.value)">
              <ion-select-option [value]="undefined">Todos</ion-select-option>
              <ion-select-option [value]="true">Activo</ion-select-option>
              <ion-select-option [value]="false">Inactivo</ion-select-option>
            </ion-select>
          </ion-col>
          <ion-col size="12" size-md="4">
            <ion-select
              placeholder="Municipio"
              interface="popover"
              class="filter-select"
              [(ngModel)]="selectedMunicipio"
              (ionChange)="selectedMunicipio.set($event.detail.value)">
              <ion-select-option value="">Todos</ion-select-option>
              <ion-select-option *ngFor="let municipio of availableMunicipios()" [value]="municipio">
                {{ municipio }}
              </ion-select-option>
            </ion-select>
          </ion-col>          <ion-col size="12" size-md="4" class="filter-buttons-col">
            <div class="filter-buttons">
              <ion-button expand="block" (click)="applyFilters()" class="filter-apply-btn">
                <ion-icon name="checkmark-outline" slot="start"></ion-icon>
                Aplicar
              </ion-button>
              <ion-button expand="block" fill="outline" (click)="clearFilters()" class="filter-clear-btn">
                <ion-icon name="close-outline" slot="start"></ion-icon>
                Limpiar
              </ion-button>
            </div>
          </ion-col>
        </ion-row>
      </ion-grid>

      <!-- Active Filters Indicator -->
      <div *ngIf="hasActiveFilters()" class="active-filters">
        <span class="text-sm text-gray-600">Filtros activos:</span>
        <ion-chip *ngIf="selectedEstado() !== undefined" color="primary" outline>
          Estado: {{ selectedEstado() ? 'Activo' : 'Inactivo' }}
        </ion-chip>
        <ion-chip *ngIf="selectedMunicipio()" color="primary" outline>
          Municipio: {{ selectedMunicipio() }}
        </ion-chip>
      </div>
    </div>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-background-color">
  <!-- Search Bar -->
  <div class="sticky top-0 z-10 bg-white shadow-sm">
    <ion-searchbar
      [(ngModel)]="searchText"
      (ionInput)="onSearchChange($event)"
      placeholder="Buscar mercados por nombre, dirección..."
      debounce="500"
      showClearButton="focus"
      class="px-4 py-3 custom-searchbar">
    </ion-searchbar>
  </div>

  <!-- Refresh Component -->
  <ion-refresher slot="fixed" (ionRefresh)="onRefresh($event)">
    <ion-refresher-content
      pullingIcon="chevron-down-circle-outline"
      pullingText="Desliza para actualizar"
      refreshingSpinner="circles"
      refreshingText="Actualizando...">
    </ion-refresher-content>
  </ion-refresher>
  <!-- Loading Skeletons -->
  <div *ngIf="loading() && mercados().length === 0" class="skeleton-container">
    <ion-grid>
      <ion-row>
        <ion-col size="12" size-md="6" size-lg="4" *ngFor="let i of [1,2,3,4,5,6]">
          <ion-card class="skeleton-card">
            <ion-card-header>
              <ion-skeleton-text animated style="width: 70%; height: 24px;"></ion-skeleton-text>
            </ion-card-header>
            <ion-card-content>
              <div class="skeleton-content">
                <ion-skeleton-text animated style="width: 90%; height: 16px; margin-bottom: 12px;"></ion-skeleton-text>
                <ion-skeleton-text animated style="width: 60%; height: 16px; margin-bottom: 12px;"></ion-skeleton-text>
                <div class="skeleton-footer">
                  <ion-skeleton-text animated style="width: 30%; height: 14px;"></ion-skeleton-text>
                  <ion-skeleton-text animated style="width: 20%; height: 14px;"></ion-skeleton-text>
                </div>
              </div>
            </ion-card-content>
          </ion-card>
        </ion-col>
      </ion-row>
    </ion-grid>
  </div>

  <!-- Markets List -->
  <div *ngIf="!loading() || mercados().length > 0" class="p-4">
    <!-- Empty State -->
    <div *ngIf="filteredMercados().length === 0" class="text-center py-12">
      <ion-icon name="business-outline" class="text-6xl text-gray-400 mb-4"></ion-icon>
      <h3 class="text-lg font-medium text-gray-600 mb-2">No hay mercados disponibles</h3>
      <p class="text-gray-500 mb-6">
        {{ searchText() ? 'No se encontraron mercados que coincidan con tu búsqueda' : 'Comienza creando tu primer mercado' }}
      </p>
      <ion-button *ngIf="canCreate() && !searchText()" (click)="createMercado()" color="primary">
        <ion-icon name="add-outline" slot="start"></ion-icon>
        Crear Mercado
      </ion-button>
    </div>    <!-- Markets Grid -->
    <ion-grid class="market-grid">
      <ion-row>
        <ion-col 
          *ngFor="let mercado of filteredMercados(); trackBy: trackByFn"
          size="12" 
          size-md="6" 
          size-lg="4">          <ion-card class="market-card">
            <!-- Card Header -->
            <ion-card-header class="market-card-header">
              <div class="flex items-start justify-between">
                <div class="flex-1">
                  <ion-card-title class="market-title">
                    {{ mercado.nombre_mercado }}
                  </ion-card-title>
                </div>
                <div class="flex items-center space-x-2 ml-2">
                  <ion-chip [color]="getStatusColor(mercado.isActive)" class="status-chip">
                    <ion-icon [name]="getStatusIcon(mercado.isActive)" class="mr-1"></ion-icon>
                    {{ mercado.isActive ? 'Activo' : 'Inactivo' }}
                  </ion-chip>
                  <ion-button 
                    fill="clear" 
                    size="small"
                    class="market-options-button" 
                    (click)="showMercadoOptions(mercado); $event.stopPropagation()">
                    <ion-icon name="ellipsis-vertical" slot="icon-only" class="text-gray-500"></ion-icon>
                  </ion-button>
                </div>
              </div>
            </ion-card-header>            <!-- Card Content -->
            <ion-card-content (click)="viewMercado(mercado)" class="market-card-content">
              <!-- Address -->
              <div class="market-info-row">
                <ion-icon name="location-outline" class="market-icon location-icon"></ion-icon>
                <span class="market-description">{{ mercado.direccion }}</span>
              </div>

              <!-- Description -->
              <div *ngIf="mercado.descripcion" class="market-info-row">
                <ion-icon name="document-text-outline" class="market-icon description-icon"></ion-icon>
                <span class="market-description">{{ mercado.descripcion }}</span>
              </div>

              <!-- Stats -->
              <div class="stats-section">
                <div class="market-info-row">
                  <ion-icon name="business-outline" class="market-icon business-icon"></ion-icon>
                  <span class="market-stat-text">
                    {{ mercado._count?.locales || 0 }} locales
                  </span>
                </div>                <div *ngIf="mercado.latitud && mercado.longitud" 
                     class="map-link"
                     (click)="showOnMap(mercado); $event.stopPropagation()">
                  <ion-icon name="map-outline" class="map-icon"></ion-icon>
                  <span class="map-text">Ver mapa</span>
                </div>
              </div>

              <!-- Actions -->
              <div class="market-actions">
                <ion-button 
                  size="small" 
                  fill="outline" 
                  class="market-action-button view-button"
                  (click)="viewMercado(mercado); $event.stopPropagation()">
                  <ion-icon name="eye-outline" slot="start"></ion-icon>
                  Ver
                </ion-button>
                <ion-button 
                  *ngIf="canEdit()"
                  size="small" 
                  fill="outline" 
                  class="market-action-button edit-button"
                  (click)="editMercado(mercado); $event.stopPropagation()">
                  <ion-icon name="create-outline" slot="start"></ion-icon>
                  Editar
                </ion-button>
              </div>
            </ion-card-content>
          </ion-card>
        </ion-col>
      </ion-row>
    </ion-grid>
  </div>

  <!-- Infinite Scroll -->
  <ion-infinite-scroll
    *ngIf="!isInfiniteDisabled()"
    (ionInfinite)="onLoadMore($event)">
    <ion-infinite-scroll-content
      loadingSpinner="crescent"
      loadingText="Cargando más mercados...">
    </ion-infinite-scroll-content>
  </ion-infinite-scroll>
  <!-- Floating Action Button -->
  <ion-fab *ngIf="canCreate()" vertical="bottom" horizontal="end" slot="fixed" class="custom-fab">
    <ion-fab-button (click)="createMercado()" class="fab-button">
      <ion-icon name="add-outline"></ion-icon>
    </ion-fab-button>
  </ion-fab>
  <!-- Action Sheet -->
  <ion-action-sheet
    [isOpen]="isActionSheetOpen()"
    (didDismiss)="isActionSheetOpen.set(false)"
    header="Opciones del Mercado"
    [buttons]="getActionSheetButtons()">
  </ion-action-sheet>

  <!-- Toast -->
  <ion-toast
    [isOpen]="isToastOpen()"
    [message]="toastMessage()"
    [duration]="3000"
    [color]="toastColor()"
    position="bottom"
    (didDismiss)="isToastOpen.set(false)">
  </ion-toast>
</ion-content>
