<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/mercados"></ion-back-button>
    </ion-buttons>
    <ion-title>Detalle del Mercado</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">  <!-- Loading spinner -->
  <div *ngIf="isLoading()" class="flex justify-center items-center h-full">
    <ion-spinner name="crescent" color="primary"></ion-spinner>
  </div>
  
  <!-- Main content -->
  <div class="container mx-auto p-4" *ngIf="!isLoading() && mercado()">
    <!-- Información Principal -->
    <ion-card>
      <ion-card-header>
        <div class="flex justify-between items-start">
          <div>
            <ion-card-title class="text-xl font-bold">
              {{ mercado()?.nombre_mercado }}
            </ion-card-title>
            <ion-badge 
              [color]="getStatusColor(mercado()?.isActive || false)"
              class="mt-2">
              {{ getStatusText(mercado()?.isActive || false) }}
            </ion-badge>
          </div>
          <ion-icon name="business-outline" size="large" color="primary"></ion-icon>
        </div>
      </ion-card-header>
      
      <ion-card-content>
        <ion-item>
          <ion-icon name="location-outline" slot="start" color="primary"></ion-icon>
          <ion-label>
            <h3>Dirección</h3>
            <p>{{ mercado()?.direccion }}</p>
          </ion-label>
        </ion-item>

        <ion-item *ngIf="mercado()?.descripcion">
          <ion-icon name="business-outline" slot="start" color="primary"></ion-icon>
          <ion-label>
            <h3>Descripción</h3>
            <p>{{ mercado()?.descripcion }}</p>
          </ion-label>
        </ion-item>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
          <ion-item>
            <ion-label>
              <h3>Latitud</h3>
              <p>{{ mercado()?.latitud }}</p>
            </ion-label>
          </ion-item>

          <ion-item>
            <ion-label>
              <h3>Longitud</h3>
              <p>{{ mercado()?.longitud }}</p>
            </ion-label>
          </ion-item>
        </div>

        <ion-item>
          <ion-icon name="calendar-outline" slot="start" color="primary"></ion-icon>
          <ion-label>
            <h3>Fecha de Creación</h3>
            <p>{{ formatDate(mercado()?.createdAt!) }}</p>
          </ion-label>
        </ion-item>

        <ion-item>
          <ion-icon name="calendar-outline" slot="start" color="primary"></ion-icon>
          <ion-label>
            <h3>Última Actualización</h3>
            <p>{{ formatDate(mercado()?.updatedAt!) }}</p>
          </ion-label>
        </ion-item>
      </ion-card-content>
    </ion-card>    <!-- Estadísticas -->
    <ion-card *ngIf="mercado()?._count">
      <ion-card-header>
        <ion-card-title class="flex items-center">
          <ion-icon name="stats-chart-outline" class="mr-2" color="primary"></ion-icon>
          Estadísticas
        </ion-card-title>
      </ion-card-header>
      
      <ion-card-content>
        <ion-item>
          <ion-label>
            <h3>Total de Locales</h3>
            <p class="text-2xl font-bold text-primary">{{ mercado()?._count?.locales || 0 }}</p>
          </ion-label>
        </ion-item>
      </ion-card-content>
    </ion-card>    <!-- Lista de Locales -->
    <ion-card *ngIf="mercado()?.locales && mercado()!.locales!.length > 0">
      <ion-card-header>
        <ion-card-title class="flex items-center justify-between">
          <div class="flex items-center">
            <ion-icon name="storefront-outline" class="mr-2" color="primary"></ion-icon>
            Locales del Mercado
          </div>
          <ion-badge color="primary">{{ filteredLocales().length }}/{{ mercado()!.locales!.length }}</ion-badge>
        </ion-card-title>
        
        <!-- Search Bar -->
        <div class="mt-4">
          <ion-searchbar
            [(ngModel)]="searchTerm"
            (ionInput)="onSearchChange($event)"
            placeholder="Buscar por DNI, número de local..."
            debounce="300"
            show-clear-button="focus"
            class="custom-searchbar">
          </ion-searchbar>
        </div>

        <!-- Filter Chips -->
        <div class="flex flex-wrap gap-2 mt-3" *ngIf="searchTerm()">
          <ion-chip color="primary" class="text-xs">
            <ion-icon name="search-outline" class="mr-1"></ion-icon>
            Búsqueda: "{{ searchTerm() }}"
            <ion-icon name="close" (click)="clearSearch()"></ion-icon>
          </ion-chip>
        </div>
      </ion-card-header>
      
      <ion-card-content class="p-0">
        <!-- No results message -->
        <div *ngIf="filteredLocales().length === 0" class="text-center py-8">
          <ion-icon name="search-outline" class="text-4xl text-gray-400 mb-2"></ion-icon>
          <h3 class="text-lg font-medium text-gray-600 mb-2">No se encontraron locales</h3>
          <p class="text-gray-500 mb-4">Intenta con otros términos de búsqueda</p>
          <ion-button fill="outline" color="primary" (click)="clearSearch()">
            <ion-icon name="refresh-outline" slot="start"></ion-icon>
            Mostrar todos
          </ion-button>
        </div>

        <!-- Locales List -->
        <div class="max-h-96 overflow-y-auto" *ngIf="filteredLocales().length > 0">
          <ion-item 
            *ngFor="let local of filteredLocales(); trackBy: trackByLocalId" 
            class="border-b border-gray-100 hover:bg-gray-50 transition-colors duration-200"
            button
            (click)="viewLocal(local)">
            
            <!-- Status Icon -->
            <div slot="start" class="flex items-center justify-center w-12 h-12 rounded-full mr-3 shadow-sm"
                 [class.bg-green-100]="local.estado_local === 'OCUPADO'"
                 [class.bg-yellow-100]="local.estado_local === 'LIBRE'"
                 [class.bg-blue-100]="local.estado_local === 'ACTIVO'"
                 [class.bg-red-100]="local.estado_local === 'INACTIVO' || local.estado_local === 'SUSPENDIDO'"
                 [class.bg-gray-100]="local.estado_local === 'PENDIENTE'">
              <ion-icon 
                [name]="getLocalStatusIcon(local.estado_local)"
                [color]="getLocalStatusColor(local.estado_local)"
                size="default">
              </ion-icon>
            </div>
            
            <!-- Main Content -->
            <ion-label class="py-3">
              <div class="flex items-start justify-between">
                <div class="flex-1">
                  <h3 class="font-semibold text-lg text-gray-800 mb-1">
                    {{ local.nombre_local || 'Local #' + local.numero_local }}
                  </h3>
                  
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-2">
                    <div class="flex items-center text-sm text-gray-600">
                      <ion-icon name="business-outline" class="mr-2 text-blue-500" size="small"></ion-icon>
                      <span><strong>N°:</strong> {{ local.numero_local }}</span>
                    </div>
                    
                    <div class="flex items-center text-sm text-gray-600" *ngIf="local.dni_propietario">
                      <ion-icon name="card-outline" class="mr-2 text-green-500" size="small"></ion-icon>
                      <span><strong>DNI:</strong> {{ local.dni_propietario }}</span>
                    </div>
                  </div>
                  
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-3" *ngIf="local.propietario">
                    <div class="flex items-center text-sm text-gray-600">
                      <ion-icon name="person-outline" class="mr-2 text-purple-500" size="small"></ion-icon>
                      <span><strong>Propietario:</strong> {{ local.propietario }}</span>
                    </div>
                    
                    <div class="flex items-center text-sm text-gray-600" *ngIf="local.telefono">
                      <ion-icon name="call-outline" class="mr-2 text-orange-500" size="small"></ion-icon>
                      <span>{{ local.telefono }}</span>
                    </div>
                  </div>
                  
                  <!-- Status Badge -->
                  <ion-chip 
                    [color]="getLocalStatusColor(local.estado_local)"
                    class="text-xs font-medium">
                    <ion-icon 
                      [name]="getLocalStatusIcon(local.estado_local)" 
                      class="mr-1" 
                      size="small">
                    </ion-icon>
                    {{ getLocalStatusText(local.estado_local) }}
                  </ion-chip>
                </div>
                
                <!-- Price Section -->
                <div class="text-right ml-4 flex flex-col items-end">
                  <div class="bg-green-50 px-3 py-2 rounded-lg border border-green-200" *ngIf="local.monto_mensual">
                    <p class="text-lg font-bold text-green-700 mb-0">
                      L {{ local.monto_mensual | number:'1.2-2' }}
                    </p>
                    <p class="text-xs text-green-600 mb-0">mensual</p>
                  </div>
                  <div class="mt-2">
                    <ion-icon name="chevron-forward-outline" class="text-gray-400"></ion-icon>
                  </div>
                </div>
              </div>
            </ion-label>
          </ion-item>
        </div>
      </ion-card-content>
    </ion-card><!-- Estado cuando no hay locales -->
    <ion-card *ngIf="mercado()?.locales && mercado()!.locales!.length === 0">
      <ion-card-content class="text-center py-8">
        <ion-icon name="storefront-outline" class="text-4xl text-gray-400 mb-2"></ion-icon>
        <h3 class="text-lg font-medium text-gray-600 mb-2">No hay locales registrados</h3>
        <p class="text-gray-500 mb-4">Este mercado aún no tiene locales registrados</p>
        <ion-button fill="outline" color="primary" (click)="addLocal()">
          <ion-icon name="add-outline" slot="start"></ion-icon>
          Agregar Local
        </ion-button>
      </ion-card-content>
    </ion-card>

    <!-- Acciones Rápidas -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>Acciones</ion-card-title>
      </ion-card-header>
      
      <ion-card-content>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <ion-button 
            expand="block" 
            fill="outline"
            (click)="viewInMap()">
            <ion-icon name="map-outline" slot="start"></ion-icon>
            Ver en Mapa
          </ion-button>

          <ion-button 
            expand="block" 
            fill="outline"
            (click)="viewLocales()">
            <ion-icon name="list-outline" slot="start"></ion-icon>
            Ver Locales
          </ion-button>

          <ion-button 
            expand="block" 
            color="primary"
            (click)="editMercado()">
            <ion-icon name="create-outline" slot="start"></ion-icon>
            Editar
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>  </div>

  <!-- Error state when no data and not loading -->
  <div *ngIf="!isLoading() && !mercado()" class="flex justify-center items-center h-full">
    <div class="text-center">
      <ion-icon name="business-outline" class="text-6xl text-gray-400 mb-4"></ion-icon>
      <h3 class="text-lg font-medium text-gray-600 mb-2">Error al cargar mercado</h3>
      <p class="text-gray-500 mb-4">No se pudo cargar la información del mercado</p>
      <ion-button fill="outline" color="primary" (click)="ngOnInit()">
        <ion-icon name="refresh-outline" slot="start"></ion-icon>
        Reintentar
      </ion-button>
    </div>
  </div>

  <!-- FAB Button -->
  <ion-fab slot="fixed" vertical="bottom" horizontal="end">
    <ion-fab-button (click)="editMercado()" color="primary">
      <ion-icon name="create-outline"></ion-icon>
    </ion-fab-button>
  </ion-fab>
</ion-content>
