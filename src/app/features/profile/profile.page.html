<ion-header class="profile-header safe-area-header">
  <div class="safe-area-spacer"></div>
  <ion-toolbar class="header-toolbar">
    <ion-buttons slot="start">
      <ion-back-button
        defaultHref="/dashboard"
        icon="arrow-back-outline"
      ></ion-back-button>
    </ion-buttons>
    <ion-title class="header-title">Mi Perfil</ion-title>
    <ion-buttons slot="end">
      <ion-button
        fill="clear"
        (click)="refreshProfile()"
        [disabled]="isLoading()"
      >
        <ion-icon
          name="refresh-outline"
          [class.rotating]="isLoading()"
        ></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="safe-area-content profile-content">
  <div class="profile-container">
    <!-- Profile Info Section -->
    <div class="profile-info-section">
      <div class="profile-avatar-container">
        <div class="profile-avatar">
          <span class="avatar-text">
            {{ currentUser() ? getInitials(currentUser()!.name ||
            currentUser()!.nombre || 'U') : 'U' }}
          </span>
        </div>
      </div>

      <div class="profile-details">
        <h2 class="profile-name">
          {{ currentUser()?.name || currentUser()?.nombre || 'Sara Anderson' }}
        </h2>
        <p class="profile-email">
          {{ currentUser()?.email || 'sara.anderson@example.com' }}
        </p>
        <div class="profile-role-badge">
          <ion-icon name="shield-outline"></ion-icon>
          <span>{{ getRoleDisplay(currentUser()?.role) }}</span>
        </div>
      </div>

      <ion-button
        fill="clear"
        class="edit-profile-btn"
        (click)="toggleEditMode()"
        [disabled]="isLoading()"
      >
        <ion-icon name="create-outline"></ion-icon>
        Edit Profile
      </ion-button>
    </div>

    <!-- Profile Settings Form -->
    <div class="profile-settings-section">
      <h3 class="section-title">Profile Settings</h3>

      <form
        [formGroup]="profileForm"
        (ngSubmit)="updateProfile()"
        class="profile-form"
      >
        <div class="form-grid">
          <!-- Username -->
          <div class="form-group">
            <label class="form-label">Username</label>
            <div class="form-input-container">
              <ion-input
                formControlName="username"
                placeholder="Enter username"
                [readonly]="!editMode"
                class="profile-input"
              >
              </ion-input>
            </div>
          </div>

          <!-- Email Address -->
          <div class="form-group">
            <label class="form-label">Email Address</label>
            <div class="form-input-container">
              <ion-input
                formControlName="email"
                type="email"
                placeholder="Enter email address"
                [readonly]="!editMode"
                class="profile-input"
              >
              </ion-input>
            </div>
          </div>

          <!-- First Name -->
          <div class="form-group">
            <label class="form-label">First Name</label>
            <div class="form-input-container">
              <ion-input
                formControlName="firstName"
                placeholder="Enter first name"
                [readonly]="!editMode"
                class="profile-input"
              >
              </ion-input>
            </div>
          </div>

          <!-- Last Name -->
          <div class="form-group">
            <label class="form-label">Last Name</label>
            <div class="form-input-container">
              <ion-input
                formControlName="lastName"
                placeholder="Enter last name"
                [readonly]="!editMode"
                class="profile-input"
              >
              </ion-input>
            </div>
          </div>

          <!-- Role (Read-only) -->
          <div class="form-group full-width">
            <label class="form-label">Role</label>
            <div class="form-input-container">
              <ion-input
                [value]="getRoleDisplay(currentUser()?.role)"
                readonly="true"
                class="profile-input readonly"
              >
              </ion-input>
            </div>
          </div>
        </div>

        <!-- Save Button -->
        <div class="form-actions" *ngIf="editMode">
          <ion-button
            type="submit"
            expand="block"
            class="save-btn"
            [disabled]="profileForm.invalid || isLoading()"
          >
            <ion-spinner
              *ngIf="isLoading()"
              name="crescent"
              slot="start"
            ></ion-spinner>
            <ion-icon
              *ngIf="!isLoading()"
              name="save-outline"
              slot="start"
            ></ion-icon>
            Save Changes
          </ion-button>
        </div>
      </form>

      <!-- Logout Button -->
      <div class="logout-section">
        <ion-button
          fill="outline"
          color="medium"
          expand="block"
          class="logout-btn"
          (click)="logout()"
        >
          <ion-icon name="log-out-outline" slot="start"></ion-icon>
          Log out
        </ion-button>
      </div>
    </div>

    <!-- Change Password Section -->
    <div class="password-section">
      <h3 class="section-title">Change Password</h3>

      <form
        [formGroup]="passwordForm"
        (ngSubmit)="changePassword()"
        class="password-form"
      >
        <!-- Current Password -->
        <div class="form-group full-width">
          <label class="form-label">Current Password</label>
          <div class="form-input-container">
            <ion-input
              formControlName="currentPassword"
              type="password"
              placeholder="••••••••"
              class="profile-input"
            >
            </ion-input>
          </div>
        </div>

        <div class="password-grid">
          <!-- New Password -->
          <div class="form-group">
            <label class="form-label">New Password</label>
            <div class="form-input-container">
              <ion-input
                formControlName="newPassword"
                type="password"
                placeholder="••••••••"
                class="profile-input"
              >
              </ion-input>
            </div>
          </div>

          <!-- Confirm New Password -->
          <div class="form-group">
            <label class="form-label">Confirm New Password</label>
            <div class="form-input-container">
              <ion-input
                formControlName="confirmPassword"
                type="password"
                placeholder="••••••••"
                class="profile-input"
              >
              </ion-input>
            </div>
          </div>
        </div>

        <!-- Update Password Button -->
        <div class="form-actions">
          <ion-button
            type="submit"
            class="update-password-btn"
            [disabled]="passwordForm.invalid || isLoading()"
          >
            <ion-spinner
              *ngIf="isLoading()"
              name="crescent"
              slot="start"
            ></ion-spinner>
            <ion-icon
              *ngIf="!isLoading()"
              name="key-outline"
              slot="start"
            ></ion-icon>
            Update Password
          </ion-button>
        </div>
      </form>
    </div>
  </div>
</ion-content>
