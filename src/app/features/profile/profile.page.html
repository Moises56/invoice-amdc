<ion-header>
  <ion-toolbar class="municipal-toolbar">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/dashboard"></ion-back-button>
    </ion-buttons>
    <ion-title class="text-white font-semibold">Mi Perfil</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="bg-gray-50">
  <div class="profile-container">
    <!-- Modern user info card -->
    <div class="profile-header" style="position:relative;">
      <ion-avatar class="avatar mb-3">
        <div class="w-full h-full bg-primary rounded-full flex items-center justify-center" style="width:100px;height:100px;">
          <span class="text-black text-2xl font-bold">
            {{ currentUser() ? getInitials(currentUser()!.name || currentUser()!.nombre || 'U') : 'U' }}
          </span>
        </div>
      </ion-avatar>
      <div class="user-name">{{ currentUser()?.name || 'Usuario' }}</div>
      <div class="user-email">{{ currentUser()?.email || '-' }}</div>
      <ion-chip class="user-role" [color]="currentUser()?.role === 'ADMIN' ? 'danger' : 'primary'" outline>
        <ion-label>{{ currentUser()?.role || 'USUARIO' }}</ion-label>
      </ion-chip>
      <ion-button fill="clear" size="small" (click)="editMode = true" *ngIf="!editMode" style="position:absolute;top:12px;right:12px;z-index:2;">
        <ion-icon name="create-outline"></ion-icon>
      </ion-button>
      <ion-button fill="clear" size="small" color="medium" (click)="cancelEdit()" *ngIf="editMode" style="position:absolute;top:12px;right:12px;z-index:2;">
        <ion-icon name="close-outline"></ion-icon>
      </ion-button>
    </div>

    <!-- Formulario de perfil -->
    <div class="profile-section">
      <div class="section-header">
        <h3><ion-icon name="person-outline" class="mr-2 text-primary"></ion-icon> Información Personal</h3>
      </div>
      <form [formGroup]="profileForm" (ngSubmit)="updateProfile()" style="padding: 16px;">
        <!-- Nombre -->
        <ion-item class="mb-3 rounded-lg custom-input" lines="none">
          <ion-label position="stacked" class="text-sm font-medium text-gray-700">
            Nombre Completo *
          </ion-label>
          <ion-input
            formControlName="name"
            placeholder="Ingrese su nombre completo"
            [readonly]="!editMode"
            [class.is-invalid]="hasError(profileForm, 'name')"
            class="mt-1">
          </ion-input>
        </ion-item>
        <div *ngIf="hasError(profileForm, 'name')" class="error-message">
          {{ getErrorMessage(profileForm, 'name') }}
        </div>

        <!-- Email -->
        <ion-item class="mb-3 rounded-lg custom-input" lines="none">
          <ion-label position="stacked" class="text-sm font-medium text-gray-700">
            Correo Electrónico *
          </ion-label>
          <ion-input
            formControlName="email"
            type="email"
            placeholder="su-email@ejemplo.com"
            [readonly]="!editMode"
            [class.is-invalid]="hasError(profileForm, 'email')"
            class="mt-1">
          </ion-input>
        </ion-item>
        <div *ngIf="hasError(profileForm, 'email')" class="error-message">
          {{ getErrorMessage(profileForm, 'email') }}
        </div>

        <!-- Teléfono -->
        <ion-item class="mb-3 rounded-lg custom-input" lines="none">
          <ion-label position="stacked" class="text-sm font-medium text-gray-700">
            Teléfono
          </ion-label>
          <ion-input
            formControlName="phone"
            type="tel"
            placeholder="Número de teléfono"
            [readonly]="!editMode"
            class="mt-1">
          </ion-input>
        </ion-item>

        <!-- Dirección -->
        <ion-item class="mb-3 rounded-lg custom-input" lines="none">
          <ion-label position="stacked" class="text-sm font-medium text-gray-700">
            Dirección
          </ion-label>
          <ion-textarea
            formControlName="address"
            placeholder="Dirección completa"
            rows="3"
            [readonly]="!editMode"
            class="mt-1">
          </ion-textarea>
        </ion-item>

        <!-- Botón actualizar perfil -->
        <ion-button 
          expand="block" 
          type="submit"
          *ngIf="editMode"
          [disabled]="profileForm.invalid || isLoading()"
          class="mt-4">
          <ion-spinner *ngIf="isLoading()" name="crescent" slot="start"></ion-spinner>
          <ion-icon *ngIf="!isLoading()" name="save-outline" slot="start"></ion-icon>
          Guardar Cambios
        </ion-button>
      </form>
    </div>

    <!-- Cambiar contraseña -->
    <div class="password-form">
      <div class="form-header">
        <h3><ion-icon name="key-outline" class="mr-2 text-primary"></ion-icon> Cambiar Contraseña</h3>
      </div>
      <form [formGroup]="passwordForm" (ngSubmit)="changePassword()">
        <!-- Contraseña actual -->
        <ion-item class="mb-3 rounded-lg custom-input" lines="none">
          <ion-label position="stacked" class="text-sm font-medium text-gray-700">
            Contraseña Actual *
          </ion-label>
          <ion-input
            formControlName="currentPassword"
            type="password"
            placeholder="Ingrese su contraseña actual"
            [class.is-invalid]="hasError(passwordForm, 'currentPassword')"
            class="mt-1">
          </ion-input>
        </ion-item>
        <div *ngIf="hasError(passwordForm, 'currentPassword')" class="error-message">
          {{ getErrorMessage(passwordForm, 'currentPassword') }}
        </div>

        <!-- Nueva contraseña -->
        <ion-item class="mb-3 rounded-lg custom-input" lines="none">
          <ion-label position="stacked" class="text-sm font-medium text-gray-700">
            Nueva Contraseña *
          </ion-label>
          <ion-input
            formControlName="newPassword"
            type="password"
            placeholder="Ingrese la nueva contraseña"
            [class.is-invalid]="hasError(passwordForm, 'newPassword')"
            class="mt-1">
          </ion-input>
        </ion-item>
        <div *ngIf="hasError(passwordForm, 'newPassword')" class="error-message">
          {{ getErrorMessage(passwordForm, 'newPassword') }}
        </div>

        <!-- Confirmar nueva contraseña -->
        <ion-item class="mb-3 rounded-lg custom-input" lines="none">
          <ion-label position="stacked" class="text-sm font-medium text-gray-700">
            Confirmar Nueva Contraseña *
          </ion-label>
          <ion-input
            formControlName="confirmPassword"
            type="password"
            placeholder="Confirme la nueva contraseña"
            [class.is-invalid]="hasError(passwordForm, 'confirmPassword')"
            class="mt-1">
          </ion-input>
        </ion-item>
        <div *ngIf="hasError(passwordForm, 'confirmPassword')" class="error-message">
          {{ getErrorMessage(passwordForm, 'confirmPassword') }}
        </div>

        <!-- Botón cambiar contraseña -->
        <div class="form-buttons">
          <ion-button 
            type="submit"
            class="save-button"
            [disabled]="passwordForm.invalid">
            <ion-icon name="key-outline" slot="start"></ion-icon>
            Cambiar Contraseña
          </ion-button>
        </div>
      </form>
    </div>

  </div>
</ion-content>
