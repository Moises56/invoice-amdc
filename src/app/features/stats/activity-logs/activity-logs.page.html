<ion-header class="activity-logs-header safe-area-header">
  <div class="safe-area-spacer"></div>
  <ion-toolbar class="header-toolbar">
    <ion-buttons slot="start">
      <ion-back-button
        defaultHref="/dashboard/user"
        icon="arrow-back-outline"
      ></ion-back-button>
    </ion-buttons>
    <ion-title class="header-title">
      <div class="title-with-icon">
        <ion-icon name="analytics" class="header-icon text-black"></ion-icon>
        Logs del Sistema
      </div>
    </ion-title>
    <ion-buttons slot="end">
      <ion-button fill="clear" (click)="refreshLogs()" [disabled]="isLoading()">
        <ion-icon
          name="refresh-outline"
          [class.rotating]="isLoading()"
        ></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="false" class="activity-logs-content logs-content" >
  <!-- Pull to refresh -->
  <ion-refresher slot="fixed" (ionRefresh)="refreshLogs($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="logs-container">
    <!-- Loading State -->
    <div
      class="loading-container"
      *ngIf="isLoading() && !activityLogs().length"
    >
      <ion-spinner name="crescent"></ion-spinner>
      <p>Cargando logs del sistema...</p>
    </div>

    <!-- Error State -->
    <div class="error-container" *ngIf="hasError() && !isLoading()">
      <div class="error-content">
        <ion-icon name="warning-outline" class="error-icon"></ion-icon>
        <h3>No se pudieron cargar los logs</h3>
        <p>{{ errorMessage() }}</p>
        <ion-button fill="solid" size="default" (click)="loadActivityLogs()">
          <ion-icon name="refresh-outline" slot="start"></ion-icon>
          Reintentar
        </ion-button>
      </div>
    </div>

    <!-- Logs Content -->
    <div
      class="logs-content-area"
      *ngIf="!isLoading() && !hasError() && activityLogs().length > 0"
    >
      <!-- Page Header -->
      <div class="page-header">
        <h1 class="page-title">Registro de Actividad</h1>
        <!-- <p class="page-subtitle">A comprehensive list of all system activities.</p> -->
      </div>

      <!-- Filter Section -->
      <div class="filter-section">
        <div class="filter-row">
          <ion-button class="export-button" (click)="exportToExcel()">
            <ion-icon name="download-outline" slot="start"></ion-icon>
            Exportar a Excel
          </ion-button>
          
          <ion-button 
            class="count-button" 
            fill="outline" 
            (click)="countTotalRecords()"
            title="Ver cuántos registros se exportarían"
          >
            <ion-icon name="analytics-outline" slot="start"></ion-icon>
            Contar Registros
          </ion-button>
        </div>

        <!-- Filtros rápidos -->
        <div class="quick-filters">
          <span class="quick-filters-label">Filtros rápidos:</span>
          <ion-button 
            fill="outline" 
            size="small" 
            (click)="applyQuickFilter('amnistia-success')"
            title="Consultas de amnistía exitosas"
          >
            <ion-icon name="checkmark-outline" slot="start"></ion-icon>
            Amnistía OK
          </ion-button>
          <ion-button 
            fill="outline" 
            size="small" 
            (click)="applyQuickFilter('ec-only')"
            title="Solo consultas EC"
          >
            <ion-icon name="document-text-outline" slot="start"></ion-icon>
            Solo EC
          </ion-button>
          <ion-button 
            fill="outline" 
            size="small" 
            (click)="applyQuickFilter('ics-only')"
            title="Solo consultas ICS"
          >
            <ion-icon name="document-outline" slot="start"></ion-icon>
            Solo ICS
          </ion-button>
          <ion-button 
            fill="outline" 
            size="small" 
            (click)="applyQuickFilter('errors-today')"
            title="Errores del día de hoy"
          >
            <ion-icon name="warning-outline" slot="start"></ion-icon>
            Errores Hoy
          </ion-button>
        </div>
        
        <!-- Filtros mejorados con nuevos endpoints -->
        <div class="additional-filters">
          <!-- Filtro por Tipo de Consulta (consultaType) -->
          <div class="filter-group">
            <label for="consultaTypeFilter">Tipo de Consulta:</label>
            <select id="consultaTypeFilter" [(ngModel)]="filterConsultaType">
              <option value="">Todas las consultas</option>
              <option value="EC">EC</option>
              <option value="ICS">ICS</option>
            </select>
          </div>
          
          <!-- Filtro por Subtipo de Consulta (consultaSubtype) -->
          <div class="filter-group">
            <label for="consultaSubtypeFilter">Subtipo de Consulta:</label>
            <select id="consultaSubtypeFilter" [(ngModel)]="filterConsultaSubtype">
              <option value="">Todos los subtipos</option>
              <option value="amnistia">Amnistía</option>
              <option value="normal">Normal</option>
              <option value="urgente">Urgente</option>
              <option value="especial">Especial</option>
            </select>
          </div>
          
          <!-- Filtro por Resultado -->
          <div class="filter-group">
            <label for="resultadoFilter">Resultado:</label>
            <select id="resultadoFilter" [(ngModel)]="filterResultado">
              <option value="">Todos los resultados</option>
              <option value="SUCCESS">SUCCESS</option>
              <option value="ERROR">ERROR</option>
              <option value="NOT_FOUND">NOT_FOUND</option>
              <option value="WARNING">WARNING</option>
            </select>
          </div>
          
          <!-- Filtro por Usuario Específico -->
          <div class="filter-group">
            <label for="usernameFilter">Usuario:</label>
            <input 
              type="text" 
              id="usernameFilter" 
              [(ngModel)]="filterUsername" 
              placeholder="ej: zgomez, mlopez..."
              title="Buscar por nombre de usuario específico"
            >
          </div>
          
          <!-- Filtro por Ubicación del Usuario -->
          <div class="filter-group">
            <label for="userLocationFilter">Ubicación:</label>
            <input 
              type="text" 
              id="userLocationFilter" 
              [(ngModel)]="filterUserLocation" 
              placeholder="ej: Mall Premier, Mercado Central..."
              title="Buscar por ubicación del usuario"
            >
          </div>
          
          <!-- Filtro por Parámetros Específicos -->
          <div class="filter-group">
            <label for="parametrosFilter">Tipo de Parámetro:</label>
            <select 
              id="parametrosFilter" 
              [(ngModel)]="filterParametros"
              title="Seleccionar tipo de parámetro para filtrar"
            >
              <option value="">Todos los parámetros</option>
              <option value="dni">DNI</option>
              <option value="claveCatastral">Clave Catastral</option>
            </select>
          </div>
          
          <!-- Filtro por Período -->
          <div class="filter-group">
            <label for="timeRangeFilter">Período:</label>
            <select id="timeRangeFilter" [(ngModel)]="filterTimeRange">
              <option value="day">Último día</option>
              <option value="week">Última semana</option>
              <option value="month">Último mes</option>
              <option value="year">Último año</option>
              <option value="custom">Personalizado</option>
            </select>
          </div>
          
          <!-- Acciones de filtros -->
          <div class="filter-actions">
            <ion-button fill="outline" size="small" (click)="clearFilters()">
              <ion-icon name="close-outline" slot="start"></ion-icon>
              Limpiar
            </ion-button>
            <ion-button fill="solid" size="small" (click)="applyFilters()">
              <ion-icon name="filter-outline" slot="start"></ion-icon>
              Aplicar
            </ion-button>
          </div>
        </div>
      </div>

      <!-- Logs Table -->
      <div class="logs-table-container">
        <div class="table-wrapper">
          <table class="logs-table">
            <thead>
              <tr>
                <th>No.</th>
                <th>FECHA</th>
                <th>CONSULTA</th>
                <th>TIPO CONSULTA</th>
                <th>PARÁMETROS</th>
                <th>RESULTADO</th>
                <th>IP</th>
                <th>DURACIÓN (MS)</th>
                <th>USUARIO</th>
                <th>ACCIONES</th>
              </tr>
            </thead>
            <tbody>
              <tr
                *ngFor="let log of paginatedLogs(); let i = index; trackBy: trackByLogId"
                class="log-row"
              >
                <td class="numero">{{ getRecordNumber(i) }}</td>
                <td class="fecha">{{ formatDate(log.createdAt) }}</td>
                <td class="tipo-consulta">{{ log.consultaType || 'N/A' }}</td>
                <td class="subtipo-consulta">
                  {{ log.consultaSubtype || 'normal' }}
                </td>
                <td class="parametros">{{ formatParameters(log) }}</td>
                <td class="resultado">
                  <span
                    class="status-badge"
                    [class]="getResultClass(log.resultado)"
                  >
                    {{ log.resultado || 'UNKNOWN' }}
                  </span>
                  <div class="result-detail" *ngIf="log.errorMessage">
                    {{ log.errorMessage }}
                  </div>
                </td>
                <td class="ip">{{ log.ip || '::1' }}</td>
                <td class="duracion">{{ log.duracionMs || '0' }}</td>
                <td class="usuario">{{ getUserFullName(log) || 'N/A' }}</td>
                <td class="acciones">
                  <ion-button fill="clear" size="small" (click)="openLogDetails(log)" class="detail-button">
                    <ion-icon name="eye-outline"></ion-icon>
                  </ion-button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Paginación Mejorada -->
        <div class="modern-pagination-container" *ngIf="totalPagesCalculated() > 1">
          <div class="pagination-info">
            <span class="info-text">Mostrando {{ getStartRecord() }} - {{ getEndRecord() }} de {{ totalRecords() }} registros</span>
            <div class="items-per-page">
              <label for="itemsPerPage">Registros por página:</label>
              <select id="itemsPerPage" [(ngModel)]="itemsPerPage" (change)="onItemsPerPageChange()">
                <option value="20">20</option>
                <option value="50">50</option>
                <option value="100">100</option>
                <option value="200">200</option>
              </select>
            </div>
          </div>
          
          <div class="pagination-controls">
            <ion-button
              fill="clear"
              class="pagination-btn first-last"
              [disabled]="getCurrentPageFromOffset() === 1"
              (click)="goToPage(1)"
              title="Primera página"
            >
              <ion-icon name="play-skip-back-outline"></ion-icon>
            </ion-button>
            
            <ion-button
              fill="clear"
              class="pagination-btn prev-next"
              [disabled]="getCurrentPageFromOffset() === 1"
              (click)="previousPage()"
              title="Página anterior"
            >
              <ion-icon name="chevron-back-outline"></ion-icon>
            </ion-button>
            
            <!-- Números de página con diseño mejorado -->
            <div class="page-numbers">
              <!-- Primera página si no está en las páginas visibles -->
              <ion-button
                *ngIf="shouldShowEllipsisBefore()"
                class="pagination-number"
                (click)="goToPage(1)"
                title="Ir a página 1"
              >
                1
              </ion-button>
              
              <!-- Elipsis antes -->
              <span *ngIf="shouldShowEllipsisBefore()" class="pagination-ellipsis">...</span>
              
              <!-- Páginas visibles -->
              <ion-button
                *ngFor="let page of getVisiblePages()"
                [class]="page === getCurrentPageFromOffset() ? 'pagination-number active' : 'pagination-number'"
                (click)="goToPage(page)"
                [title]="'Ir a página ' + page"
              >
                {{ page }}
              </ion-button>
              
              <!-- Elipsis después -->
              <span *ngIf="shouldShowEllipsisAfter()" class="pagination-ellipsis">...</span>
              
              <!-- Última página si no está en las páginas visibles -->
              <ion-button
                *ngIf="shouldShowEllipsisAfter()"
                class="pagination-number"
                (click)="goToPage(totalPagesCalculated())"
                [title]="'Ir a página ' + totalPagesCalculated()"
              >
                {{ totalPagesCalculated() }}
              </ion-button>
            </div>
            
            <ion-button
              fill="clear"
              class="pagination-btn prev-next"
              [disabled]="getCurrentPageFromOffset() === totalPagesCalculated()"
              (click)="nextPage()"
              title="Página siguiente"
            >
              <ion-icon name="chevron-forward-outline"></ion-icon>
            </ion-button>
            
            <ion-button
              fill="clear"
              class="pagination-btn first-last"
              [disabled]="getCurrentPageFromOffset() === totalPagesCalculated()"
              (click)="goToPage(totalPagesCalculated())"
              title="Última página"
            >
              <ion-icon name="play-skip-forward-outline"></ion-icon>
            </ion-button>
          </div>
          
          <div class="quick-jump">
            <label for="pageJump">Ir a página:</label>
            <input
              type="number"
              id="pageJump"
              #pageInput
              [min]="1"
              [max]="totalPagesCalculated()"
              placeholder="#"
              (keyup.enter)="jumpToPage(pageInput.value); pageInput.value = ''"
            />
            <ion-button
              fill="clear"
              class="jump-btn"
              (click)="jumpToPage(pageInput.value); pageInput.value = ''"
              title="Ir a página"
            >
              <ion-icon name="arrow-forward-outline"></ion-icon>
            </ion-button>
          </div>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div
      class="empty-state"
      *ngIf="!isLoading() && !hasError() && activityLogs().length === 0"
    >
      <ion-icon name="document-outline"></ion-icon>
      <h3>No hay logs disponibles</h3>
      <p>No se encontraron logs de actividad</p>
      <ion-button fill="outline" (click)="loadActivityLogs()">
        <ion-icon name="refresh-outline" slot="start"></ion-icon>
        Actualizar
      </ion-button>
    </div>
  </div>
</ion-content>

<!-- Modal para detalles del log -->
<div class="log-details-modal" [class.open]="isModalOpen()" (click)="closeLogDetails()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">Detalles del Log</h2>
      <ion-button fill="clear" (click)="closeLogDetails()" class="close-button">
        <ion-icon name="close-outline"></ion-icon>
      </ion-button>
    </div>
    
    <div class="modal-body" *ngIf="selectedLog()">
      <div class="detail-section">
        <h3 class="section-title">Información General</h3>
        <div class="detail-row">
          <div class="detail-label">ID:</div>
          <div class="detail-value">{{ selectedLog()?.id }}</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">Fecha:</div>
          <div class="detail-value">{{ formatDate(selectedLog()?.createdAt) }}</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">Usuario:</div>
          <div class="detail-value">{{ getUserFullName(selectedLog()) }}</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">Ubicación:</div>
          <div class="detail-value">{{ selectedLog()?.userLocation || 'No especificada' }}</div>
        </div>
      </div>
      
      <div class="detail-section">
        <h3 class="section-title">Detalles de la Consulta</h3>
        <div class="detail-row">
          <div class="detail-label">Tipo:</div>
          <div class="detail-value">{{ selectedLog()?.consultaType || 'N/A' }}</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">Subtipo:</div>
          <div class="detail-value">{{ selectedLog()?.consultaSubtype || 'normal' }}</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">Parámetros:</div>
          <div class="detail-value code-block">{{ formatParametersFormatted(selectedLog()) }}</div>
        </div>
      </div>
      
      <div class="detail-section">
        <h3 class="section-title">Resultado</h3>
        <div class="detail-row">
          <div class="detail-label">Estado:</div>
          <div class="detail-value">
            <span class="status-badge" [class]="getResultClass(selectedLog()?.resultado || '')">
              {{ selectedLog()?.resultado || 'UNKNOWN' }}
            </span>
          </div>
        </div>
        <div class="detail-row" *ngIf="selectedLog()?.errorMessage">
          <div class="detail-label">Error:</div>
          <div class="detail-value error-message">{{ selectedLog()?.errorMessage }}</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">Duración:</div>
          <div class="detail-value">{{ selectedLog()?.duracionMs || '0' }} ms</div>
        </div>
      </div>
      
      <div class="detail-section">
        <h3 class="section-title">Información Técnica</h3>
        <div class="detail-row">
          <div class="detail-label">IP:</div>
          <div class="detail-value">{{ selectedLog()?.ip || '::1' }}</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">User Agent:</div>
          <div class="detail-value user-agent">{{ selectedLog()?.userAgent || 'No disponible' }}</div>
        </div>
      </div>
      
      <div class="detail-section user-agent-details" *ngIf="selectedLog()?.userAgent">
        <h3 class="section-title">Detalles del User Agent</h3>
        <div class="user-agent-parsed">
          <div class="detail-row">
            <div class="detail-label">Navegador:</div>
            <div class="detail-value">{{ selectedLog() && selectedLog()?.userAgent ? parseUserAgent(selectedLog()?.userAgent).browser : 'No disponible' }}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Sistema operativo:</div>
            <div class="detail-value">{{ selectedLog() && selectedLog()?.userAgent ? parseUserAgent(selectedLog()?.userAgent).os : 'No disponible' }}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Dispositivo:</div>
            <div class="detail-value">{{ selectedLog() && selectedLog()?.userAgent ? parseUserAgent(selectedLog()?.userAgent).device : 'No disponible' }}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Tipo:</div>
            <div class="detail-value">{{ selectedLog() && selectedLog()?.userAgent ? parseUserAgent(selectedLog()?.userAgent).type : 'No disponible' }}</div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="modal-footer">
      <ion-button fill="outline" (click)="closeLogDetails()">
        Cerrar
      </ion-button>
    </div>
  </div>
</div>
