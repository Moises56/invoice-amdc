<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/dashboard/user"></ion-back-button>
    </ion-buttons>
    <ion-title>Consulta ICS</ion-title>
    <ion-buttons slot="end">
      <ion-button 
        *ngIf="tieneResultados" 
        fill="clear" 
        (click)="imprimirICS()">
        <ion-icon name="print-outline" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">Consulta ICS</ion-title>
    </ion-toolbar>
  </ion-header>

  <div class="container">
    <!-- Componente de búsqueda ICS -->
    <app-search-ics-input
      [disabled]="isLoading()"
      [clearOnSearch]="false"
      (search)="onSearch($event)"
      (clear)="onClear()">
    </app-search-ics-input>

    <!-- Indicador de carga -->
    <div *ngIf="isLoading()" class="loading-container">
      <ion-spinner name="crescent" color="primary"></ion-spinner>
      <ion-text color="medium">
        <p>Consultando información ICS...</p>
      </ion-text>
    </div>

    <!-- Mensaje de error -->
    <ion-card *ngIf="searchError()" class="error-card">
      <ion-card-content>
        <div class="error-content">
          <ion-icon name="alert-circle" color="danger"></ion-icon>
          <div>
            <h3>Error en la consulta</h3>
            <p>{{ searchError() }}</p>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Resultados de la consulta -->
    <div *ngIf="tieneResultados && !isLoading()" class="results-container">
      
      <!-- Información del propietario -->
      <ion-card class="owner-card glass-card">
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="person-outline" color="primary"></ion-icon>
            Información del Propietario
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="owner-info">
            <div class="info-row">
              <span class="label">Nombre:</span>
              <span class="value">{{ propietario?.nombre }}</span>
            </div>
            <div class="info-row" *ngIf="propietario?.dni">
              <span class="label">DNI:</span>
              <span class="value">{{ propietario?.dni }}</span>
            </div>
            <div class="info-row" *ngIf="propietario?.rtn">
              <span class="label">RTN:</span>
              <span class="value">{{ propietario?.rtn }}</span>
            </div>
            <div class="info-row" *ngIf="lastSearchParams?.ics">
              <span class="label">Código ICS:</span>
              <span class="value">{{ lastSearchParams?.ics }}</span>
            </div>
            <div class="info-row">
              <span class="label">Fecha de Consulta:</span>
              <span class="value">{{ getFechaConsulta() }}</span>
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Selector de empresas (si hay múltiples) -->
      <ion-card *ngIf="esBusquedaMultiple" class="empresas-container glass-card">
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="business-outline"></ion-icon>
            Empresas Encontradas ({{ totalEmpresas }})
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="empresas-list">
            <ion-item 
              *ngFor="let empresa of getEmpresas(); let i = index" 
              button="true"
              (click)="seleccionarEmpresa(i)"
              [class.selected]="indicePropiedadSeleccionada() === i"
              class="empresa-item">
              <ion-icon name="business" slot="start" [color]="indicePropiedadSeleccionada() === i ? 'primary' : 'medium'"></ion-icon>
              <ion-label>
                <h3>{{ empresa.numeroEmpresa }}</h3>
                <p>{{ empresa.mes }}</p>
                <p class="total-empresa">Total: {{ formatCurrency(empresa.totalPropiedadNumerico) }}</p>
              </ion-label>
              <ion-icon 
                *ngIf="indicePropiedadSeleccionada() === i" 
                name="checkmark-circle" 
                color="primary" 
                slot="end">
              </ion-icon>
            </ion-item>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Información de la empresa seleccionada -->
      <ion-card *ngIf="empresaSeleccionada()" class="info-card glass-card unified-info-card" style="display:flex;align-items:center;gap:1.5rem;padding:1.5rem 2rem;background:linear-gradient(90deg,#e0f7fa 0%,#f5fafd 100%);box-shadow:0 4px 16px rgba(62,198,224,0.10);margin-bottom:2.2rem;">
        <div style="flex-shrink:0;">
          <div style="width:56px;height:56px;background:#3ec6e0;border-radius:50%;display:flex;align-items:center;justify-content:center;">
            <ion-icon name="business-outline" style="font-size:2.5rem;color:#fff;"></ion-icon>
          </div>
        </div>
        <div style="flex:1;min-width:0;">
          <div style="font-size:1.3rem;font-weight:700;color:#3ec6e0;line-height:1.1;letter-spacing:0.5px;">{{ empresaSeleccionada()?.numeroEmpresa }}</div>
          <div style="font-size:1rem;color:#0097a7;font-weight:600;">{{ empresaSeleccionada()?.mes }}</div>
          <div style="margin-top:1rem;">
            <span style="font-weight:600;color:#222;">Total Empresa:</span> <span style="color:#0097a7;font-weight:700;font-size:1.1rem;">{{ formatCurrency(empresaSeleccionada()?.totalPropiedadNumerico || 0) }}</span>
            <br>
            <span style="font-weight:600;color:#222;">Fecha:</span> <span style="color:#0097a7;font-weight:600;">{{ getFechaConsulta() }}</span>
          </div>
        </div>
      </ion-card>

      <!-- Resumen financiero -->
      <div *ngIf="consultaResponse()" class="summary-card glass-card" style="background:linear-gradient(90deg,#e0f7fa 0%,#f5fafd 100%);box-shadow:0 4px 16px rgba(62,198,224,0.10);margin-bottom:2.2rem;">
        <div class="summary-header" style="padding:1.2rem 1.5rem 0.5rem 1.5rem;">
          <h3 style="font-size:1.15rem;font-weight:700;color:#0097a7;margin:0 0 0.5rem 0;letter-spacing:0.5px;">Resumen Financiero</h3>
        </div>
        <div class="summary-content" style="padding:0 1.5rem 1.2rem 1.5rem;">
          <div class="summary-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem 2rem;align-items:center;">
            <div class="summary-item" style="font-size:1rem;color:#222;">
              <span class="label" style="font-weight:600;">Total General:</span>
              <span class="value" style="font-weight:700;color:#0097a7;">{{ formatCurrency(consultaResponse()?.totalGeneralNumerico || 0) }}</span>
            </div>
            <div class="summary-item discount" style="font-size:1rem;color:#222;">
              <span class="label" style="font-weight:600;">Descuento Pronto Pago:</span>
              <span class="value discount-value" style="font-weight:700;color:#ff9800;">-{{ formatCurrency(consultaResponse()?.descuentoProntoPagoNumerico || 0) }}</span>
            </div>
            <div class="summary-item total" style="font-size:1rem;color:#222;grid-column:1/3;">
              <span class="label" style="font-weight:600;">Total a Pagar:</span>
              <span class="value total-value" style="font-weight:700;color:#43a047;font-size:1.1rem;">{{ formatCurrency(consultaResponse()?.totalAPagarNumerico || 0) }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Detalle de mora eliminado -->

      <!-- Información de búsqueda -->
      <ion-card class="search-info-card">
        <ion-card-content>
          <div class="search-summary">
            <ion-icon name="search-outline"></ion-icon>
            <span>Búsqueda: {{ getSearchSummary() }}</span>
            <span class="date">{{ getFechaConsulta() }}</span>
          </div>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Estado vacío -->
    <div *ngIf="!tieneResultados && !isLoading() && !searchError()" class="empty-state">
      <ion-icon name="search-outline" color="medium"></ion-icon>
      <h3>Consulta ICS</h3>
      <p>Ingrese un DNI, RTN o código ICS para consultar el estado de cuenta del Impuesto de Construcción y Solvencia.</p>
    </div>
  </div>
</ion-content>