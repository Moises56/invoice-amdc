<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/audit"></ion-back-button>
    </ion-buttons>
    <ion-title>Detalle de Auditoría</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="copyToClipboard(logId(), 'ID del log')" *ngIf="!loading()">
        <ion-icon name="copy-outline" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">Detalle de Auditoría</ion-title>
    </ion-toolbar>
  </ion-header>

  <!-- Loading -->
  <div *ngIf="loading()" class="flex justify-center items-center h-64">
    <ion-spinner name="crescent" color="primary"></ion-spinner>
  </div>

  <!-- Contenido del log -->
  <div *ngIf="!loading() && auditLog()" class="p-4">
    <!-- Información principal -->
    <ion-card class="mb-4">
      <ion-card-header>
        <div class="flex items-center justify-between">
          <ion-card-title class="text-xl">Información General</ion-card-title>
          <ion-chip [color]="getActionColor(auditLog()!.accion)">
            <ion-icon [name]="getActionIcon(auditLog()!.accion)" class="mr-1"></ion-icon>
            {{ auditLog()!.accion }}
          </ion-chip>
        </div>
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          <ion-item>
            <ion-icon name="information-circle-outline" slot="start" color="primary"></ion-icon>
            <ion-label>
              <h3>ID del Log</h3>
              <p class="font-mono text-sm">{{ auditLog()!.id }}</p>
            </ion-label>
            <ion-button fill="clear" (click)="copyToClipboard(auditLog()!.id, 'ID del log')">
              <ion-icon name="copy-outline" slot="icon-only"></ion-icon>
            </ion-button>
          </ion-item>

          <ion-item>
            <ion-icon name="document-text-outline" slot="start" color="secondary"></ion-icon>
            <ion-label>
              <h3>Tabla Afectada</h3>
              <p>{{ auditLog()!.tabla }}</p>
            </ion-label>
          </ion-item>

          <ion-item *ngIf="auditLog()!.registro_id">
            <ion-icon name="code-slash-outline" slot="start" color="tertiary"></ion-icon>
            <ion-label>
              <h3>ID del Registro</h3>
              <p class="font-mono text-sm">{{ auditLog()!.registro_id }}</p>
            </ion-label>
            <ion-button fill="clear" (click)="copyToClipboard(auditLog()!.registro_id!, 'ID del registro')">
              <ion-icon name="copy-outline" slot="icon-only"></ion-icon>
            </ion-button>
          </ion-item>

          <ion-item>
            <ion-icon name="time-outline" slot="start" color="warning"></ion-icon>
            <ion-label>
              <h3>Fecha y Hora</h3>
              <p>{{ formatDate(auditLog()!.createdAt) }}</p>
            </ion-label>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <!-- Información del usuario -->
    <ion-card class="mb-4" *ngIf="auditLog()!.user">
      <ion-card-header>
        <ion-card-title class="text-xl flex items-center">
          <ion-icon name="person-outline" class="mr-2"></ion-icon>
          Usuario Responsable
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          <ion-item>
            <ion-label>
              <h3>Nombre Completo</h3>
              <p>{{ auditLog()!.user!.nombre }} {{ auditLog()!.user!.apellido }}</p>
            </ion-label>
          </ion-item>

          <ion-item>
            <ion-label>
              <h3>Correo Electrónico</h3>
              <p>{{ auditLog()!.user!.correo }}</p>
            </ion-label>
          </ion-item>

          <ion-item>
            <ion-label>
              <h3>Rol</h3>
              <ion-badge color="primary">{{ auditLog()!.user!.role }}</ion-badge>
            </ion-label>
          </ion-item>

          <ion-item>
            <ion-label>
              <h3>ID de Usuario</h3>
              <p class="font-mono text-sm">{{ auditLog()!.userId }}</p>
            </ion-label>
            <ion-button fill="clear" (click)="copyToClipboard(auditLog()!.userId, 'ID de usuario')">
              <ion-icon name="copy-outline" slot="icon-only"></ion-icon>
            </ion-button>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <!-- Información técnica -->
    <ion-card class="mb-4" *ngIf="auditLog()!.ip_address || auditLog()!.user_agent">
      <ion-card-header>
        <ion-card-title class="text-xl flex items-center">
          <ion-icon name="globe-outline" class="mr-2"></ion-icon>
          Información Técnica
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          <ion-item *ngIf="auditLog()!.ip_address">
            <ion-icon name="globe-outline" slot="start" color="medium"></ion-icon>
            <ion-label>
              <h3>Dirección IP</h3>
              <p class="font-mono">{{ auditLog()!.ip_address }}</p>
            </ion-label>
            <ion-button fill="clear" (click)="copyToClipboard(auditLog()!.ip_address!, 'Dirección IP')">
              <ion-icon name="copy-outline" slot="icon-only"></ion-icon>
            </ion-button>
          </ion-item>

          <ion-item *ngIf="auditLog()!.user_agent">
            <ion-icon name="desktop-outline" slot="start" color="medium"></ion-icon>
            <ion-label>
              <h3>User Agent</h3>
              <p class="text-sm break-all">{{ auditLog()!.user_agent }}</p>
            </ion-label>
            <ion-button fill="clear" (click)="copyToClipboard(auditLog()!.user_agent!, 'User Agent')">
              <ion-icon name="copy-outline" slot="icon-only"></ion-icon>
            </ion-button>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <!-- Cambios de datos -->
    <ion-card *ngIf="hasDataChanges()">
      <ion-card-header>
        <ion-card-title class="text-xl flex items-center">
          <ion-icon name="code-slash-outline" class="mr-2"></ion-icon>
          Cambios en los Datos
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <!-- Vista de comparación por campos -->
        <div *ngIf="auditLog()!.accion === 'UPDATE' && getChangedKeys().length > 0" class="mb-6">
          <ion-list-header>
            <ion-label>
              <h2>Comparación de Campos</h2>
              <p>Campos que fueron modificados</p>
            </ion-label>
          </ion-list-header>
          
          <div *ngFor="let key of getChangedKeys()" class="mb-4">
            <div class="p-3 border border-gray-200 rounded-lg" [class.bg-yellow-50]="hasFieldChanged(key)">
              <h4 class="font-semibold text-sm mb-2 text-gray-700">{{ key }}</h4>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <!-- Valor anterior -->
                <div>
                  <ion-text color="danger">
                    <h5 class="text-xs font-medium mb-1">Valor Anterior</h5>
                  </ion-text>
                  <div class="p-2 bg-red-50 border border-red-200 rounded text-xs font-mono">
                    <pre class="whitespace-pre-wrap">{{ getOldValue(key) || 'null' }}</pre>
                  </div>
                </div>
                
                <!-- Valor nuevo -->
                <div>
                  <ion-text color="success">
                    <h5 class="text-xs font-medium mb-1">Valor Nuevo</h5>
                  </ion-text>
                  <div class="p-2 bg-green-50 border border-green-200 rounded text-xs font-mono">
                    <pre class="whitespace-pre-wrap">{{ getNewValue(key) || 'null' }}</pre>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Vista completa de datos -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <!-- Datos anteriores -->
          <div *ngIf="auditLog()!.datos_anteriores">
            <ion-list-header>
              <ion-label>
                <h3>Datos Anteriores</h3>
                <p>Estado previo del registro</p>
              </ion-label>
            </ion-list-header>
            <div class="p-3 bg-red-50 border border-red-200 rounded-lg">
              <pre class="text-xs font-mono whitespace-pre-wrap overflow-x-auto">{{ formatJSON(auditLog()!.datos_anteriores) }}</pre>
            </div>
            <ion-button 
              fill="outline" 
              size="small" 
              class="mt-2" 
              (click)="copyToClipboard(formatJSON(auditLog()!.datos_anteriores), 'Datos anteriores')"
            >
              <ion-icon name="copy-outline" slot="start"></ion-icon>
              Copiar
            </ion-button>
          </div>

          <!-- Datos nuevos -->
          <div *ngIf="auditLog()!.datos_nuevos">
            <ion-list-header>
              <ion-label>
                <h3>Datos Nuevos</h3>
                <p>Estado actual del registro</p>
              </ion-label>
            </ion-list-header>
            <div class="p-3 bg-green-50 border border-green-200 rounded-lg">
              <pre class="text-xs font-mono whitespace-pre-wrap overflow-x-auto">{{ formatJSON(auditLog()!.datos_nuevos) }}</pre>
            </div>
            <ion-button 
              fill="outline" 
              size="small" 
              class="mt-2" 
              (click)="copyToClipboard(formatJSON(auditLog()!.datos_nuevos), 'Datos nuevos')"
            >
              <ion-icon name="copy-outline" slot="start"></ion-icon>
              Copiar
            </ion-button>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Mensaje cuando no hay cambios de datos -->
    <ion-card *ngIf="!hasDataChanges()">
      <ion-card-content class="text-center py-8">
        <ion-icon name="information-circle-outline" class="text-4xl text-gray-300 mb-2"></ion-icon>
        <h3 class="text-lg font-medium text-gray-500 mb-1">Sin cambios de datos</h3>
        <p class="text-gray-400 text-sm">
          Esta acción no registró cambios en los datos del sistema
        </p>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Error state -->
  <div *ngIf="!loading() && !auditLog()" class="text-center py-8">
    <ion-icon name="alert-circle-outline" class="text-6xl text-red-300 mb-4"></ion-icon>
    <h3 class="text-lg font-medium text-gray-500 mb-2">Log no encontrado</h3>
    <p class="text-gray-400">El log de auditoría solicitado no existe o fue eliminado</p>
    <ion-button routerLink="/audit" class="mt-4">
      <ion-icon name="arrow-back-outline" slot="start"></ion-icon>
      Volver a la lista
    </ion-button>
  </div>
</ion-content>
