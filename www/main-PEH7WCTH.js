import{a as l}from"./chunk-76SUSZ7P.js";import{$ as Je,$a as et,Aa as Xe,Ha as Ye,Ka as Ze,Sa as Ne,Y as Ge,a as Be,bb as tt,db as nt,fb as rt,h as Ke,na as Qe,s as We,v as ze}from"./chunk-PIGH2764.js";import{$ as qe,A as Ue,B as je,D as $e,P as De,R as Fe,T as He,X as Ve,a as Ee,f as Se,r as Re,v as Te,y as Ie,z as Le}from"./chunk-SOBSCE5F.js";import{b as y}from"./chunk-OKK4U6ED.js";import{a as ot,b as it}from"./chunk-B4FAM7CU.js";import"./chunk-EDQZMFWJ.js";import"./chunk-AL5IVEPX.js";import{$a as O,A as W,B as z,Fa as be,J as E,Ja as ve,Ka as we,M as ge,Q as te,Sa as Ce,T as G,Ta as ye,Xa as Ae,Y as g,Ya as Pe,Z as C,_ as I,_a as xe,a as le,ab as _e,bb as Oe,c as ue,ca as ne,cb as Me,da as J,ea as L,h as N,j as de,l as B,m as me,ma as S,n as ee,na as Q,o as he,p as pe,r as fe,sc as ke,u as K,x as h}from"./chunk-WYTV4Y2I.js";import"./chunk-OQQFKM4V.js";import"./chunk-QUJFQN2Y.js";import"./chunk-J7JITKZC.js";import"./chunk-BOXIHRYD.js";import"./chunk-OHGEMRV5.js";import"./chunk-XQESWZ4T.js";import"./chunk-7KGURMOZ.js";import"./chunk-KLXKYU2M.js";import"./chunk-SIK2P2H5.js";import"./chunk-4BNUL4C7.js";import"./chunk-M66VC23L.js";import"./chunk-JMWLUS2D.js";import"./chunk-EUVXMWSF.js";import"./chunk-LBMIQEU6.js";import"./chunk-WI5MSH4N.js";import"./chunk-USUO6L27.js";import"./chunk-CKP3SGE2.js";import"./chunk-2LFY4CRM.js";import"./chunk-PJL56ILQ.js";import"./chunk-NVWEJ7GR.js";import"./chunk-UVAVEIEI.js";import"./chunk-E6CW6KXY.js";import"./chunk-Z3EESIK6.js";import"./chunk-4U6PRYVA.js";import"./chunk-FXFZIWDD.js";import"./chunk-CSG5OQLY.js";import"./chunk-VMHM3MLJ.js";import"./chunk-6WKZVARI.js";import"./chunk-C5RQ2IC2.js";import"./chunk-42C7ZIID.js";import{a as ce,h as c}from"./chunk-LNJ3S2LQ.js";var b=(()=>{let e=class e{constructor(){this.authService=h(y),this.router=h(O),this.AUTH_CHECK_TIMEOUT=5e3}canActivate(){return this.checkAuth()}checkAuth(){return c(this,null,function*(){console.log("\u{1F6E1}\uFE0F AuthGuard: Verificando autenticaci\xF3n...");let r=0,o=50;for(;!this.authService.authCheckComplete()&&r<o;)yield new Promise(i=>setTimeout(i,100)),r++;if(r>=o)return console.log("\u26A0\uFE0F AuthGuard: Timeout en verificaci\xF3n inicial, usando fallback"),yield this.checkAuthWithFallback();if(this.authService.isAuthenticated())return console.log("\u2705 Usuario autenticado, permitiendo acceso"),!0;try{if(yield this.checkAuthWithTimeout())return console.log("\u2705 Usuario autenticado despu\xE9s de verificaci\xF3n con timeout"),!0}catch(i){console.log("\u274C Error en verificaci\xF3n de autenticaci\xF3n con timeout:",i)}return console.log("\u{1F6AB} Usuario no autenticado, redirigiendo al login"),this.router.createUrlTree(["/login"])})}checkAuthWithTimeout(){return new Promise((r,o)=>{let i=B(this.AUTH_CHECK_TIMEOUT),s=this.authService.checkAuthStatus();me(s,i.pipe(de(()=>{throw new Error("Timeout")}))).subscribe({next:a=>r(a),error:a=>{a.message==="Timeout"?(console.log("\u23F0 Timeout en verificaci\xF3n de autenticaci\xF3n"),r(!1)):o(a)}})})}checkAuthWithFallback(){return c(this,null,function*(){try{if(yield this.authService.checkAuthStatus())return console.log("\u2705 Usuario autenticado en fallback"),!0}catch(r){console.log("\u274C Error en fallback de verificaci\xF3n:",r)}return console.log("\u{1F6AB} Fallback: Usuario no autenticado"),this.router.createUrlTree(["/login"])})}};e.\u0275fac=function(o){return new(o||e)},e.\u0275prov=K({token:e,factory:e.\u0275fac,providedIn:"root"});let t=e;return t})();var M=(()=>{let e=class e{constructor(){this.authService=h(y),this.router=h(O)}canActivate(r){let o=r.data.roles;return this.authService.isAuthenticated()?!o||o.length===0||this.authService.hasAnyRole(o)?!0:this.router.createUrlTree(["/dashboard"]):this.router.createUrlTree(["/login"])}};e.\u0275fac=function(o){return new(o||e)},e.\u0275prov=K({token:e,factory:e.\u0275fac,providedIn:"root"});let t=e;return t})();var at=(t,e)=>{let n=h(y),r=h(O),o=n.user();if(o){if(o.role===l.USER){if(e.url!=="/dashboard/user")return r.navigate(["/dashboard/user"]),!1}else if(e.url==="/dashboard/user")return r.navigate(["/dashboard"]),!1}return!0};var ct=[{path:"",redirectTo:"/dashboard",pathMatch:"full"},{path:"login",loadComponent:()=>import("./chunk-Q5UAKV3G.js").then(t=>t.LoginPage)},{path:"dashboard",canActivate:[b,at],children:[{path:"",loadComponent:()=>import("./chunk-D7RTXLF5.js").then(t=>t.DashboardPage),data:{roles:[l.ADMIN,l.MARKET]}},{path:"user",loadComponent:()=>import("./chunk-RSOYWQYI.js").then(t=>t.UserDashboardPage),data:{roles:[l.USER]}}]},{path:"estado-cuenta",loadChildren:()=>import("./chunk-7XHVJSYP.js").then(t=>t.routes),canActivate:[b,M],data:{roles:[l.USER]}},{path:"estado-cuenta-amnistia",loadChildren:()=>import("./chunk-HVZRKP3X.js").then(t=>t.routes),canActivate:[b,M],data:{roles:[l.USER]}},{path:"reportes",loadComponent:()=>import("./chunk-ZDUPFRIU.js").then(t=>t.ReportesPage),canActivate:[b]},{path:"usuarios",loadChildren:()=>import("./chunk-4T6QUKIZ.js").then(t=>t.routes),canActivate:[b,M],data:{roles:[l.ADMIN]}},{path:"mercados",loadChildren:()=>import("./chunk-3PUGWPWY.js").then(t=>t.routes),canActivate:[b,M],data:{roles:[l.ADMIN,l.MARKET]}},{path:"locales",loadChildren:()=>import("./chunk-TR5GT3AO.js").then(t=>t.routes),canActivate:[b,M],data:{roles:[l.ADMIN,l.MARKET,l.USER]}},{path:"facturas",loadChildren:()=>import("./chunk-JF3IOF4H.js").then(t=>t.routes),canActivate:[b,M],data:{roles:[l.ADMIN,l.MARKET,l.USER]}},{path:"auditoria",loadChildren:()=>import("./chunk-O4F4KV55.js").then(t=>t.routes),canActivate:[b,M],data:{roles:[l.ADMIN]}},{path:"bluetooth",loadChildren:()=>import("./chunk-27LNACIS.js").then(t=>t.routes),canActivate:[b]},{path:"perfil",loadComponent:()=>import("./chunk-NLIHTLOY.js").then(t=>t.ProfilePage),canActivate:[b]},{path:"**",redirectTo:"/dashboard"}];function bt(t,e){if(t&1){let n=ne();g(0,"ion-menu-toggle",21)(1,"ion-item",18),J("click",function(){let o=W(n).$implicit,i=L(2);return z(i.navigateTo(o.url))}),I(2,"ion-icon",22),g(3,"ion-label",17),S(4),C()()()}if(t&2){let n=e.$implicit;E(2),G("name",n.icon),E(2),Q(n.title)}}function vt(t,e){if(t&1){let n=ne();g(0,"ion-menu",2)(1,"ion-header")(2,"ion-toolbar",3)(3,"ion-title",4),S(4," AMDC "),C()()(),g(5,"ion-content")(6,"div",5)(7,"div",6)(8,"div",7),I(9,"ion-icon",8),C(),g(10,"div",9)(11,"h3",10),S(12),C(),g(13,"p",11),S(14),C()()()(),g(15,"ion-list",12),te(16,bt,5,2,"ion-menu-toggle",13),C(),g(17,"div",14)(18,"ion-item",15),J("click",function(){W(n);let o=L();return z(o.goToProfile())}),I(19,"ion-icon",16),g(20,"ion-label",17),S(21,"Mi Perfil"),C()(),g(22,"ion-item",18),J("click",function(){W(n);let o=L();return z(o.logout())}),I(23,"ion-icon",19),g(24,"ion-label",20),S(25,"Cerrar Sesi\xF3n"),C()()()()()}if(t&2){let n=L();E(12),Q(n.userName()),E(2),Q(n.userRole()),E(2),G("ngForOf",n.visibleMenuItems())}}var lt=(()=>{let e=class e{constructor(){this.authService=h(y),this.router=h(O),this.menuController=h(Ve),this.user=this.authService.user,this.isAuthenticated=this.authService.isAuthenticated,this.userName=this.authService.userName,this.userRole=this.authService.userRole,this.adminMenu=[{title:"Dashboard",url:"/dashboard",icon:"stats-chart-outline"},{title:"Usuarios",url:"/usuarios",icon:"people-outline"},{title:"Mercados",url:"/mercados",icon:"business-outline"},{title:"Locales",url:"/locales",icon:"storefront-outline"},{title:"Facturas",url:"/facturas",icon:"receipt-outline"},{title:"Reportes",url:"/reportes",icon:"document-attach-outline"},{title:"Auditor\xEDa",url:"/auditoria",icon:"analytics-outline"},{title:"Config. Bluetooth",url:"/bluetooth",icon:"bluetooth-outline"}],this.marketMenu=[{title:"Dashboard",url:"/dashboard",icon:"stats-chart-outline"},{title:"Mercados",url:"/mercados",icon:"business-outline"},{title:"Locales",url:"/locales",icon:"storefront-outline"},{title:"Facturas",url:"/facturas",icon:"receipt-outline"},{title:"Reportes",url:"/reportes",icon:"document-attach-outline"},{title:"Config. Bluetooth",url:"/bluetooth",icon:"bluetooth-outline"}],this.userMenu=[{title:"Mi Dashboard",url:"/dashboard/user",icon:"home-outline"},{title:"Estado de Cuenta",url:"/estado-cuenta",icon:"document-text-outline"},{title:"Cuenta con Amnist\xEDa",url:"/estado-cuenta-amnistia",icon:"shield-checkmark-outline"},{title:"Config. Bluetooth",url:"/bluetooth",icon:"bluetooth-outline"}],this.visibleMenuItems=be(()=>{switch(this.authService.userRole()){case l.ADMIN:return this.adminMenu;case l.MARKET:return this.marketMenu;case l.USER:return this.userMenu;default:return[]}}),Be({homeOutline:Qe,businessOutline:ze,storefrontOutline:rt,receiptOutline:Ne,peopleOutline:Ye,analyticsOutline:Ke,bluetoothOutline:We,personOutline:Ze,logOutOutline:Xe,settingsOutline:et,documentTextOutline:Je,shieldCheckmarkOutline:tt,statsChartOutline:nt,documentAttachOutline:Ge})}ngOnInit(){}navigateTo(r){this.router.navigateByUrl(r),this.menuController.close()}goToProfile(){this.router.navigate(["/perfil"]),this.menuController.close()}logout(){this.authService.logout().subscribe(),this.menuController.close()}};e.\u0275fac=function(o){return new(o||e)},e.\u0275cmp=ge({type:e,selectors:[["app-root"]],decls:3,vars:1,consts:[["contentId","main-content","type","overlay",4,"ngIf"],["id","main-content"],["contentId","main-content","type","overlay"],[1,"municipal-toolbar"],[1,"text-white","font-semibold","ml-3"],[1,"user-info","p-4","bg-gray-50","border-b","border-gray-200"],[1,"flex","items-center"],[1,"w-12","h-12","bg-primary","rounded-full","flex","items-center","justify-center","mr-3"],["name","person-outline",1,"text-white","text-xl"],[1,"flex-1"],[1,"font-semibold","text-gray-800","text-sm"],[1,"text-xs","text-gray-500"],[1,"py-2"],["autoHide","false",4,"ngFor","ngForOf"],[1,"mt-auto","p-4","border-t","border-gray-200"],["button","true",1,"menu-item","mb-2",3,"click"],["name","person-outline","slot","start","color","medium"],[1,"font-medium"],["button","true",1,"menu-item",3,"click"],["name","log-out-outline","slot","start","color","danger"],[1,"font-medium","text-red-600"],["autoHide","false"],["slot","start","color","medium",3,"name"]],template:function(o,i){o&1&&(g(0,"ion-app"),te(1,vt,26,3,"ion-menu",0),I(2,"ion-router-outlet",1),C()),o&2&&(E(),G("ngIf",i.isAuthenticated()))},dependencies:[Ce,ve,we,Se,Ee,je,Te,Fe,De,Re,Ue,Ie,qe,Le,$e],styles:[".municipal-toolbar[_ngcontent-%COMP%]{--background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);--color: white}.user-info[_ngcontent-%COMP%]{background-color:#f9fafb;border-bottom:1px solid #e5e7eb}.menu-item[_ngcontent-%COMP%]{--padding-start: 1rem;--padding-end: 1rem;--border-radius: .5rem;margin:.25rem .5rem;transition:all .2s ease}.menu-item[_ngcontent-%COMP%]:hover{--background: #f3f4f6;transform:translate(4px)}.p-4[_ngcontent-%COMP%]{padding:1rem}.py-2[_ngcontent-%COMP%]{padding-top:.5rem;padding-bottom:.5rem}.mt-auto[_ngcontent-%COMP%]{margin-top:auto}.mb-2[_ngcontent-%COMP%]{margin-bottom:.5rem}.mr-3[_ngcontent-%COMP%]{margin-right:.75rem}.bg-gray-50[_ngcontent-%COMP%]{background-color:#f9fafb}.bg-primary[_ngcontent-%COMP%]{background-color:var(--primary)}.border-b[_ngcontent-%COMP%]{border-bottom-width:1px}.border-t[_ngcontent-%COMP%]{border-top-width:1px}.border-gray-200[_ngcontent-%COMP%]{border-color:#e5e7eb}.flex[_ngcontent-%COMP%]{display:flex}.flex-1[_ngcontent-%COMP%]{flex:1 1 0%}.items-center[_ngcontent-%COMP%]{align-items:center}.w-12[_ngcontent-%COMP%]{width:3rem}.h-12[_ngcontent-%COMP%]{height:3rem}.rounded-full[_ngcontent-%COMP%]{border-radius:9999px}.justify-center[_ngcontent-%COMP%]{justify-content:center}.text-white[_ngcontent-%COMP%]{color:#fff}.text-gray-500[_ngcontent-%COMP%]{color:#6b7280}.text-gray-800[_ngcontent-%COMP%]{color:#1f2937}.text-red-600[_ngcontent-%COMP%]{color:#dc2626}.text-xs[_ngcontent-%COMP%]{font-size:.75rem;line-height:1rem}.text-sm[_ngcontent-%COMP%]{font-size:.875rem;line-height:1.25rem}.text-xl[_ngcontent-%COMP%]{font-size:1.25rem;line-height:1.75rem}.font-medium[_ngcontent-%COMP%]{font-weight:500}.font-semibold[_ngcontent-%COMP%]{font-weight:600}ion-menu[_ngcontent-%COMP%]{--width: 280px}ion-menu[_ngcontent-%COMP%]   ion-content[_ngcontent-%COMP%]{--padding-bottom: 0}ion-list[_ngcontent-%COMP%]{padding:.5rem 0}"]});let t=e;return t})();var j=function(t){return t.Unimplemented="UNIMPLEMENTED",t.Unavailable="UNAVAILABLE",t}(j||{}),U=class extends Error{constructor(e,n,r){super(e),this.message=e,this.code=n,this.data=r}},wt=t=>{var e,n;return t!=null&&t.androidBridge?"android":!((n=(e=t==null?void 0:t.webkit)===null||e===void 0?void 0:e.messageHandlers)===null||n===void 0)&&n.bridge?"ios":"web"},Ct=t=>{let e=t.CapacitorCustomPlatform||null,n=t.Capacitor||{},r=n.Plugins=n.Plugins||{},o=()=>e!==null?e.name:wt(t),i=()=>o()!=="web",s=u=>{let d=A.get(u);return!!(d!=null&&d.platforms.has(o())||a(u))},a=u=>{var d;return(d=n.PluginHeaders)===null||d===void 0?void 0:d.find(H=>H.name===u)},p=u=>t.console.error(u),A=new Map,F=(u,d={})=>{let H=A.get(u);if(H)return console.warn(`Capacitor plugin "${u}" already registered. Cannot register plugins twice.`),H.proxy;let k=o(),T=a(u),P,pt=()=>c(null,null,function*(){return!P&&k in d?P=typeof d[k]=="function"?P=yield d[k]():P=d[k]:e!==null&&!P&&"web"in d&&(P=typeof d.web=="function"?P=yield d.web():P=d.web),P}),ft=(m,f)=>{var w,x;if(T){let _=T==null?void 0:T.methods.find(v=>f===v.name);if(_)return _.rtype==="promise"?v=>n.nativePromise(u,f.toString(),v):(v,V)=>n.nativeCallback(u,f.toString(),v,V);if(m)return(w=m[f])===null||w===void 0?void 0:w.bind(m)}else{if(m)return(x=m[f])===null||x===void 0?void 0:x.bind(m);throw new U(`"${u}" plugin is not implemented on ${k}`,j.Unimplemented)}},Y=m=>{let f,w=(...x)=>{let _=pt().then(v=>{let V=ft(v,m);if(V){let q=V(...x);return f=q==null?void 0:q.remove,q}else throw new U(`"${u}.${m}()" is not implemented on ${k}`,j.Unimplemented)});return m==="addListener"&&(_.remove=()=>c(null,null,function*(){return f()})),_};return w.toString=()=>`${m.toString()}() { [capacitor code] }`,Object.defineProperty(w,"name",{value:m,writable:!1,configurable:!1}),w},se=Y("addListener"),ae=Y("removeListener"),gt=(m,f)=>{let w=se({eventName:m},f),x=()=>c(null,null,function*(){let v=yield w;ae({eventName:m,callbackId:v},f)}),_=new Promise(v=>w.then(()=>v({remove:x})));return _.remove=()=>c(null,null,function*(){console.warn("Using addListener() without 'await' is deprecated."),yield x()}),_},Z=new Proxy({},{get(m,f){switch(f){case"$$typeof":return;case"toJSON":return()=>({});case"addListener":return T?gt:se;case"removeListener":return ae;default:return Y(f)}}});return r[u]=Z,A.set(u,{name:u,proxy:Z,platforms:new Set([...Object.keys(d),...T?[k]:[]])}),Z};return n.convertFileSrc||(n.convertFileSrc=u=>u),n.getPlatform=o,n.handleError=p,n.isNativePlatform=i,n.isPluginAvailable=s,n.registerPlugin=F,n.Exception=U,n.DEBUG=!!n.DEBUG,n.isLoggingEnabled=!!n.isLoggingEnabled,n},yt=t=>t.Capacitor=Ct(t),$=yt(typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:typeof global<"u"?global:{}),mt=$.registerPlugin,X=class{constructor(){this.listeners={},this.retainedEventArguments={},this.windowListeners={}}addListener(e,n){let r=!1;this.listeners[e]||(this.listeners[e]=[],r=!0),this.listeners[e].push(n);let i=this.windowListeners[e];i&&!i.registered&&this.addWindowListener(i),r&&this.sendRetainedArgumentsForEvent(e);let s=()=>c(this,null,function*(){return this.removeListener(e,n)});return Promise.resolve({remove:s})}removeAllListeners(){return c(this,null,function*(){this.listeners={};for(let e in this.windowListeners)this.removeWindowListener(this.windowListeners[e]);this.windowListeners={}})}notifyListeners(e,n,r){let o=this.listeners[e];if(!o){if(r){let i=this.retainedEventArguments[e];i||(i=[]),i.push(n),this.retainedEventArguments[e]=i}return}o.forEach(i=>i(n))}hasListeners(e){var n;return!!(!((n=this.listeners[e])===null||n===void 0)&&n.length)}registerWindowListener(e,n){this.windowListeners[n]={registered:!1,windowEventName:e,pluginEventName:n,handler:r=>{this.notifyListeners(n,r)}}}unimplemented(e="not implemented"){return new $.Exception(e,j.Unimplemented)}unavailable(e="not available"){return new $.Exception(e,j.Unavailable)}removeListener(e,n){return c(this,null,function*(){let r=this.listeners[e];if(!r)return;let o=r.indexOf(n);this.listeners[e].splice(o,1),this.listeners[e].length||this.removeWindowListener(this.windowListeners[e])})}addWindowListener(e){window.addEventListener(e.windowEventName,e.handler),e.registered=!0}removeWindowListener(e){e&&(window.removeEventListener(e.windowEventName,e.handler),e.registered=!1)}sendRetainedArgumentsForEvent(e){let n=this.retainedEventArguments[e];n&&(delete this.retainedEventArguments[e],n.forEach(r=>{this.notifyListeners(e,r)}))}};var ut=t=>encodeURIComponent(t).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape),dt=t=>t.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent),re=class extends X{getCookies(){return c(this,null,function*(){let e=document.cookie,n={};return e.split(";").forEach(r=>{if(r.length<=0)return;let[o,i]=r.replace(/=/,"CAP_COOKIE").split("CAP_COOKIE");o=dt(o).trim(),i=dt(i).trim(),n[o]=i}),n})}setCookie(e){return c(this,null,function*(){try{let n=ut(e.key),r=ut(e.value),o=`; expires=${(e.expires||"").replace("expires=","")}`,i=(e.path||"/").replace("path=",""),s=e.url!=null&&e.url.length>0?`domain=${e.url}`:"";document.cookie=`${n}=${r||""}${o}; path=${i}; ${s};`}catch(n){return Promise.reject(n)}})}deleteCookie(e){return c(this,null,function*(){try{document.cookie=`${e.key}=; Max-Age=0`}catch(n){return Promise.reject(n)}})}clearCookies(){return c(this,null,function*(){try{let e=document.cookie.split(";")||[];for(let n of e)document.cookie=n.replace(/^ +/,"").replace(/=.*/,`=;expires=${new Date().toUTCString()};path=/`)}catch(e){return Promise.reject(e)}})}clearAllCookies(){return c(this,null,function*(){try{yield this.clearCookies()}catch(e){return Promise.reject(e)}})}},dn=mt("CapacitorCookies",{web:()=>new re}),At=t=>c(null,null,function*(){return new Promise((e,n)=>{let r=new FileReader;r.onload=()=>{let o=r.result;e(o.indexOf(",")>=0?o.split(",")[1]:o)},r.onerror=o=>n(o),r.readAsDataURL(t)})}),Pt=(t={})=>{let e=Object.keys(t);return Object.keys(t).map(o=>o.toLocaleLowerCase()).reduce((o,i,s)=>(o[i]=t[e[s]],o),{})},xt=(t,e=!0)=>t?Object.entries(t).reduce((r,o)=>{let[i,s]=o,a,p;return Array.isArray(s)?(p="",s.forEach(A=>{a=e?encodeURIComponent(A):A,p+=`${i}=${a}&`}),p.slice(0,-1)):(a=e?encodeURIComponent(s):s,p=`${i}=${a}`),`${r}&${p}`},"").substr(1):null,_t=(t,e={})=>{let n=Object.assign({method:t.method||"GET",headers:t.headers},e),o=Pt(t.headers)["content-type"]||"";if(typeof t.data=="string")n.body=t.data;else if(o.includes("application/x-www-form-urlencoded")){let i=new URLSearchParams;for(let[s,a]of Object.entries(t.data||{}))i.set(s,a);n.body=i.toString()}else if(o.includes("multipart/form-data")||t.data instanceof FormData){let i=new FormData;if(t.data instanceof FormData)t.data.forEach((a,p)=>{i.append(p,a)});else for(let a of Object.keys(t.data))i.append(a,t.data[a]);n.body=i;let s=new Headers(n.headers);s.delete("content-type"),n.headers=s}else(o.includes("application/json")||typeof t.data=="object")&&(n.body=JSON.stringify(t.data));return n},oe=class extends X{request(e){return c(this,null,function*(){let n=_t(e,e.webFetchExtra),r=xt(e.params,e.shouldEncodeUrlParams),o=r?`${e.url}?${r}`:e.url,i=yield fetch(o,n),s=i.headers.get("content-type")||"",{responseType:a="text"}=i.ok?e:{};s.includes("application/json")&&(a="json");let p,A;switch(a){case"arraybuffer":case"blob":A=yield i.blob(),p=yield At(A);break;case"json":p=yield i.json();break;case"document":case"text":default:p=yield i.text()}let F={};return i.headers.forEach((u,d)=>{F[d]=u}),{data:p,headers:F,status:i.status,url:i.url}})}get(e){return c(this,null,function*(){return this.request(Object.assign(Object.assign({},e),{method:"GET"}))})}post(e){return c(this,null,function*(){return this.request(Object.assign(Object.assign({},e),{method:"POST"}))})}put(e){return c(this,null,function*(){return this.request(Object.assign(Object.assign({},e),{method:"PUT"}))})}patch(e){return c(this,null,function*(){return this.request(Object.assign(Object.assign({},e),{method:"PATCH"}))})}delete(e){return c(this,null,function*(){return this.request(Object.assign(Object.assign({},e),{method:"DELETE"}))})}},mn=mt("CapacitorHttp",{web:()=>new oe});var D=!1,ie=new ue(null),R=[],ht=(t,e)=>{let n=h(y);if(!t.url.includes("/api/"))return e(t);let r=$.isNativePlatform(),o=t.clone({setHeaders:ce({"Content-Type":"application/json"},r&&{"Access-Control-Allow-Credentials":"true"}),withCredentials:!0});return e(o).pipe(pe({count:1,delay:(i,s)=>{if(i.status===0||i.status>=500)return console.log(`\u{1F504} Retrying request ${s}/1 due to network error`),B(1e3);throw i}}),ee(i=>i.status===401&&!Et(t.url)?(console.log("\u{1F504} Token expirado, intentando renovar..."),Ot(o,e,n)):N(()=>i)))};function Ot(t,e,n){return D?(console.log("\u23F3 Agregando petici\xF3n a la cola de espera..."),new le(r=>{R.push({request:t.clone({withCredentials:!0}),next:e,resolve:o=>{r.next(o),r.complete()},reject:o=>{r.error(o)}})})):(D=!0,ie.next(null),console.log("\u{1F504} Iniciando renovaci\xF3n de token..."),n.refreshToken().pipe(fe(()=>(console.log("\u2705 Token renovado exitosamente en interceptor"),D=!1,ie.next(!0),Mt(),e(t.clone({withCredentials:!0})))),ee(r=>(console.log("\u274C Error al renovar token en interceptor:",r),D=!1,ie.next(null),kt(r),r.status===401&&(console.log("\u{1F6AB} Refresh token expirado, forzando logout"),n.forceLogout()),N(()=>r))),he(()=>{D=!1})))}function Mt(){console.log(`\u{1F504} Procesando ${R.length} peticiones pendientes...`),R.forEach(({request:t,next:e,resolve:n,reject:r})=>{e(t).subscribe({next:n,error:r})}),R=[]}function kt(t){console.log(`\u274C Rechazando ${R.length} peticiones pendientes...`),R.forEach(({reject:e})=>{e(t)}),R=[]}function Et(t){return t.includes("/auth/login")||t.includes("/auth/refresh")||t.includes("/auth/profile")||t.includes("/auth/logout")}ye(lt,{providers:[ot,it,{provide:xe,useClass:ke},He(),Oe(ct,Me(_e)),Ae(Pe([ht]))]});
