import{u as S}from"./chunk-EDQZMFWJ.js";import{a as p}from"./chunk-AL5IVEPX.js";import{$a as g,Fa as d,I as n,Wa as f,d as A,h,l as T,n as l,p as m,s as c,u as E,x as u}from"./chunk-WYTV4Y2I.js";import{h as a}from"./chunk-LNJ3S2LQ.js";var o={BASE_URL:p.apiUrl||"http://localhost:3000/api",ENDPOINTS:{AUTH:{LOGIN:"/auth/login",LOGOUT:"/auth/logout",REFRESH:"/auth/refresh",PROFILE:"/auth/profile",CHANGE_PASSWORD:"/auth/change-password"},USERS:{BASE:"/usuarios",BY_ID:s=>`/usuarios/${s}`,STATS:"/usuarios/stats"},MERCADOS:{BASE:"/mercados",BY_ID:s=>`/mercados/${s}`,STATS:"/mercados/stats"},LOCALES:{BASE:"/locales",BY_ID:s=>`/locales/${s}`,BY_MERCADO:s=>`/locales/mercado/${s}`,STATS:"/locales/stats"},FACTURAS:{BASE:"/facturas",BY_ID:s=>`/facturas/${s}`,BY_LOCAL:s=>`/facturas/local/${s}`,MASSIVE:"/facturas/massive",STATS:"/facturas/stats"},AUDIT:{BASE:"/audit",BY_ID:s=>`/audit/${s}`,BY_USER:s=>`/audit/user/${s}`,STATS:"/audit/stats"}}};var $=(()=>{let r=class r{constructor(){this.http=u(f),this.router=u(g),this.toastController=u(S),this._user=n(null),this._isAuthenticated=n(!1),this._isLoading=n(!0),this._authCheckComplete=n(!1),this._initializationState=n("checking"),this.refreshInProgress=!1,this.REFRESH_INTERVAL=13*60*1e3,this.MAX_RETRY_ATTEMPTS=3,this.retryAttempts=0,this.user=this._user.asReadonly(),this.isAuthenticated=this._isAuthenticated.asReadonly(),this.isLoading=this._isLoading.asReadonly(),this.authCheckComplete=this._authCheckComplete.asReadonly(),this.initializationState=this._initializationState.asReadonly(),this.userRole=d(()=>{var t;return((t=this._user())==null?void 0:t.role)||null}),this.userName=d(()=>{let t=this._user();return t?`${t.nombre} ${t.apellido}`:""}),console.log("\u{1F527} AuthService: Inicializando..."),this.initializeAuth()}initializeAuth(){return a(this,null,function*(){console.log("\u{1F527} AuthService: Iniciando verificaci\xF3n de autenticaci\xF3n..."),this._initializationState.set("checking"),this._isLoading.set(!0),this.retryAttempts=0;try{yield this.attemptAuthInitialization()}catch(t){console.error("\u274C AuthService: Error cr\xEDtico en inicializaci\xF3n:",t),this._initializationState.set("failed"),this.clearAuthState()}})}attemptAuthInitialization(){return a(this,null,function*(){for(;this.retryAttempts<this.MAX_RETRY_ATTEMPTS;)try{console.log(`\u{1F504} AuthService: Intento ${this.retryAttempts+1}/${this.MAX_RETRY_ATTEMPTS} de verificaci\xF3n...`);let t=yield this.getProfile().toPromise();if(t!=null&&t.user){this._user.set(t.user),this._isAuthenticated.set(!0),this._initializationState.set("success"),this.startTokenRefreshTimer(),console.log("\u2705 Usuario autenticado autom\xE1ticamente:",t.user);break}else{console.log("\u2139\uFE0F No hay sesi\xF3n activa v\xE1lida"),this.clearAuthState();break}}catch(t){if(this.retryAttempts++,console.log(`\u274C Intento ${this.retryAttempts} fall\xF3:`,t.message),this.retryAttempts>=this.MAX_RETRY_ATTEMPTS){console.log("\u274C No hay sesi\xF3n activa o token expirado despu\xE9s de todos los intentos"),this.clearAuthState();break}let e=Math.pow(2,this.retryAttempts)*1e3;console.log(`\u23F3 Esperando ${e}ms antes del siguiente intento...`),yield new Promise(i=>setTimeout(i,e))}this._isLoading.set(!1),this._authCheckComplete.set(!0),console.log("\u{1F3C1} AuthService: Inicializaci\xF3n completada")})}checkAuthStatus(){return a(this,null,function*(){try{let t=yield this.getProfile().toPromise();return t!=null&&t.user?(this._user.set(t.user),this._isAuthenticated.set(!0),!0):!1}catch{return this.clearAuthState(),!1}})}login(t){return console.log("\u{1F510} Iniciando login..."),this._isLoading.set(!0),this.http.post(`${o.BASE_URL}${o.ENDPOINTS.AUTH.LOGIN}`,t,{withCredentials:!0}).pipe(c(e=>{console.log("\u2705 Login exitoso:",e.user),this._user.set(e.user),this._isAuthenticated.set(!0),this._isLoading.set(!1),this._initializationState.set("success"),this._authCheckComplete.set(!0),this.startTokenRefreshTimer(),this.showToast("Inicio de sesi\xF3n exitoso","success")}),l(e=>(console.error("\u274C Error en login:",e),this._isLoading.set(!1),this.handleAuthError(e),h(()=>e))))}logout(){return console.log("\u{1F6AA} Cerrando sesi\xF3n..."),this._isLoading.set(!0),this.stopTokenRefreshTimer(),this.http.post(`${o.BASE_URL}${o.ENDPOINTS.AUTH.LOGOUT}`,{},{withCredentials:!0}).pipe(c(()=>{console.log("\u2705 Logout exitoso"),this.clearAuthState(),this.router.navigate(["/login"]),this.showToast("Sesi\xF3n cerrada exitosamente","success")}),l(t=>(console.log("\u26A0\uFE0F Error en logout pero limpiando sesi\xF3n local:",t),this.clearAuthState(),this.router.navigate(["/login"]),h(()=>t))))}getProfile(){return this.http.post(`${o.BASE_URL}${o.ENDPOINTS.AUTH.PROFILE}`,{},{withCredentials:!0})}refreshToken(){return this.refreshInProgress?(console.log("\u{1F504} Refresh ya en progreso, evitando duplicaci\xF3n"),A):(this.refreshInProgress=!0,console.log("\u{1F504} Renovando token..."),this.http.post(`${o.BASE_URL}${o.ENDPOINTS.AUTH.REFRESH}`,{},{withCredentials:!0}).pipe(m({count:2,delay:(t,e)=>(console.log(`\u{1F504} Retry ${e} para refresh token...`),T(1e3*e))}),c(t=>{console.log("\u2705 Token renovado exitosamente"),this.refreshInProgress=!1}),l(t=>(console.log("\u274C Error al renovar token:",t),this.refreshInProgress=!1,t.status===401&&(console.log("\u{1F6AB} Refresh token expirado, forzando logout"),this.forceLogout()),h(()=>t)))))}startTokenRefreshTimer(){this.stopTokenRefreshTimer(),console.log("\u23F0 Timer de renovaci\xF3n de token iniciado (cada 13 minutos)"),this.tokenRefreshTimer=setInterval(()=>{this._isAuthenticated()&&!this.refreshInProgress&&(console.log("\u{1F504} Renovando token autom\xE1ticamente..."),this.refreshToken().subscribe({next:()=>{console.log("\u2705 Token renovado autom\xE1ticamente")},error:t=>{console.error("\u274C Error en renovaci\xF3n autom\xE1tica:",t),t.status===401&&(console.log("\u{1F6AB} Forzando logout por sesi\xF3n expirada"),this.forceLogout())}}))},this.REFRESH_INTERVAL)}stopTokenRefreshTimer(){this.tokenRefreshTimer&&(clearInterval(this.tokenRefreshTimer),this.tokenRefreshTimer=void 0,console.log("\u23F9\uFE0F Timer de renovaci\xF3n detenido"))}clearAuthState(){console.log("\u{1F9F9} Limpiando estado de autenticaci\xF3n..."),this._user.set(null),this._isAuthenticated.set(!1),this._isLoading.set(!1),this._initializationState.set("failed"),this._authCheckComplete.set(!0),this.stopTokenRefreshTimer(),this.refreshInProgress=!1,this.retryAttempts=0;try{localStorage.removeItem("user"),localStorage.removeItem("token"),sessionStorage.clear()}catch(t){console.log("\u26A0\uFE0F Error limpiando localStorage:",t)}}changePassword(t,e){return this.http.post(`${o.BASE_URL}${o.ENDPOINTS.AUTH.CHANGE_PASSWORD}`,{currentPassword:t,newPassword:e},{withCredentials:!0}).pipe(c(()=>{this.showToast("Contrase\xF1a cambiada exitosamente","success")}),l(i=>(this.handleAuthError(i),h(()=>i))))}hasRole(t){var e;return((e=this._user())==null?void 0:e.role)===t}hasAnyRole(t){var i;let e=(i=this._user())==null?void 0:i.role;return e?t.includes(e):!1}forceLogout(){console.log("\u{1F6AB} Forzando logout por sesi\xF3n expirada"),this.clearAuthState(),this.router.navigate(["/login"]),this.showToast("Sesi\xF3n expirada. Por favor, inicie sesi\xF3n nuevamente.","warning")}attemptTokenRefresh(){return a(this,null,function*(){try{return yield this.refreshToken().toPromise(),!0}catch(t){return console.error("\u274C Error al intentar renovar token:",t),t.status===401&&this.forceLogout(),!1}})}handleAuthError(t){var i;let e="Error desconocido";(i=t.error)!=null&&i.message?e=t.error.message:t.status===401?e="Credenciales inv\xE1lidas o sesi\xF3n expirada":t.status===403?e="No tiene permisos para realizar esta acci\xF3n":t.status===0?e="Error de conexi\xF3n. Verifique su conexi\xF3n a internet.":t.status>=500&&(e="Error interno del servidor. Intente nuevamente."),this.showToast(e,"danger"),console.error("\u274C Error de autenticaci\xF3n:",t)}showToast(t,e){return a(this,null,function*(){(yield this.toastController.create({message:t,duration:3e3,position:"top",color:e})).present()})}isTokenExpiredError(t){var e;return t.status===401&&!((e=t.url)!=null&&e.includes("/auth/login"))}clearAuth(){this.clearAuthState(),this.router.navigate(["/login"])}};r.\u0275fac=function(e){return new(e||r)},r.\u0275prov=E({token:r,factory:r.\u0275fac,providedIn:"root"});let s=r;return s})();export{o as a,$ as b};
